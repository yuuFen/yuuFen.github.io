<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://yuufen.com/blog</id>
    <title>YuuFen</title>
    <updated>2020-06-26T14:05:04.369Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://yuufen.com/blog"/>
    <link rel="self" href="https://yuufen.com/blog/atom.xml"/>
    <subtitle>å¸Œæœ›ä½ å¯ä»¥è®°ä½æˆ‘</subtitle>
    <logo>https://yuufen.com/blog/images/avatar.png</logo>
    <icon>https://yuufen.com/blog/favicon.ico</icon>
    <rights>All rights reserved 2020, YuuFen</rights>
    <entry>
        <title type="html"><![CDATA[ä½ å¥½å‘€ï¼Œé™Œç”Ÿäºº]]></title>
        <id>https://yuufen.com/blog/post/about/</id>
        <link href="https://yuufen.com/blog/post/about/">
        </link>
        <updated>2024-02-28T16:00:00.000Z</updated>
        <content type="html"><![CDATA[<blockquote>
<p>æ¬¢è¿æ¥åˆ°æˆ‘çš„å°ç«™å‘€ï¼Œå¾ˆé«˜å…´é‡è§ä½ ï¼ğŸ¤</p>
</blockquote>
<h2 id="å…³äºæœ¬ç«™">ğŸ  å…³äºæœ¬ç«™</h2>
<p>å› ä¸ºç¬”è®°å¤ªå¤šå¤ªæ‚ï¼Œå†³å®šå®šæœŸå†™å†™åšå®¢æ•´ç†æ•´ç†ç¬”è®°ã€‚</p>
<p><s>ç„¶åå› ä¸ºå„ç§åŸå› å¤±å»äº†åŠ¨åŠ›</s></p>
<p><s>å› æ­¤æä¸¢äº†å¥½å¤šç¬”è®°å•Šå•Šå•Šå•Šå•Šå•Šå•ŠğŸ˜­ğŸ˜­ğŸ˜­</s></p>
<p><s>çœ‹äº†çœ‹ä¸€å¹´å‰çš„åšæ–‡å‘ç°è‡ªå·±çœŸçš„å˜åŒ–äº†è›®å¤šçš„ï¼ˆåŠ æ²¹ğŸ’ªï¼‰</s></p>
<p>æ€»ä¹‹ç°åœ¨åˆå¼€å§‹äº†</p>
<h2 id="å…³äºæˆ‘">ğŸŸ å…³äºæˆ‘</h2>
<p>æˆ‘ç›®å‰å¤§äºŒåœ¨è¯»ï¼Œæˆ‘çš„èŒä¸šè§„åˆ’æ˜¯å‰ç«¯å·¥ç¨‹å¸ˆï¼Œæˆ‘çš„ä¸“ä¸šæ˜¯ç”µå­ä¿¡æ¯ï¼Œæ‰€ä»¥æˆ‘è¿˜äº†è§£ä¸€äº›åµŒå…¥å¼å¼€å‘ï¼ˆå½“ç„¶åªæ˜¯ä¸€äº›äº›ï¼‰ï¼Œå¯¹Pythonå’ŒTensorFlowä¹Ÿæœ‰ä¸€å®šçš„æ¶‰çŒã€‚æˆ‘æ­£åœ¨åŠªåŠ›å¯»æ‰¾æš‘æœŸå®ä¹ ï¼</p>
<p>åœ¨ä»¥ä¸‹ä½ç½®æ‰¾åˆ°æœ‰å…³æˆ‘çš„æ›´å¤šä¿¡æ¯ï¼š</p>
<p><a href="https://yuufen.com/" target="_blank" class="text-button">ä¸»é¡µ</a><a href="https://yuufen.com/blog" target="_blank" class="text-button">åšå®¢</a><a href="https://github.com/yuuFen" target="_blank" class="text-button">é¡¹ç›®</a><a href="mailto:me@yuufen.com" class="text-button">ç»™æˆ‘å‘é‚®ä»¶</a></p>
<h2 id="å…´è¶£çˆ±å¥½">ğŸ¨ å…´è¶£çˆ±å¥½</h2>
<p><strong>æ‘„å½±</strong>ã€ç¾½æ¯›çƒã€è½®æ»‘ï¼Œand playing!</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[ç”¨æˆ·é‰´æƒçš„å››ç§æ–¹å¼]]></title>
        <id>https://yuufen.com/blog/post/g--Ijm-z9/</id>
        <link href="https://yuufen.com/blog/post/g--Ijm-z9/">
        </link>
        <updated>2020-06-25T22:57:16.000Z</updated>
        <content type="html"><![CDATA[<blockquote>
<p>å¸¸ç”¨é‰´æƒæ–¹å¼</p>
<ul>
<li>Session / Cookie</li>
<li>Token</li>
<li>OAuth</li>
<li>SSO</li>
</ul>
</blockquote>
<h2 id="session-cookie">Session - Cookie</h2>
<h3 id="åŸç†">åŸç†</h3>
<blockquote>
<p>å®ç°åŸï§¤ï¼š</p>
<ol>
<li>æœåŠ¡ï¨¸åœ¨æ¥å—å®¢æˆ·ç«¯é¦–æ¬¡è®¿é—®æ—¶åœ¨æœåŠ¡ï¨¸ç«¯åˆ›å»ºå¹¶å‚¨å­˜ seesion (æˆ‘ä»¬å¯ä»¥å°† seesion ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œä¹Ÿå¯ä»¥ä¿å­˜åœ¨ <strong>redis</strong> ä¸­ï¼Œæ¨èä½¿ç”¨åè€…)ï¼Œç„¶åç»™è¿™ä¸ª session ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†å­—ç¬¦ï¤…sid,å¹¶åœ¨å“åº”å¤´ä¸­ç§ä¸‹è¿™ä¸ªå”¯ä¸€æ ‡è¯†å­—ç¬¦ï¤…ã€‚</li>
<li>ç­¾åã€‚é€šè¿‡ç§˜é’¥å¯¹sidè¿›ï¨ˆç­¾åå¤„ï§¤ï¼Œé¿å…å®¢æˆ·ç«¯ä¿®æ”¹sidã€‚ï¼ˆéå¿…éœ€æ­¥éª¤ï¼‰
<ol>
<li>å“ˆå¸Œ Hash - SHA MD5 HMAC</li>
<li>æ‘˜è¦</li>
<li>å¯¹ç§° DES</li>
<li>éå¯¹ç§° - RSA</li>
</ol>
</li>
<li>æµè§ˆï¨¸ä¸­æ”¶åˆ°è¯·æ±‚å“åº”çš„æ—¶å€™ä¼šè§£æå“åº”å¤´ï¼Œå°†sidä¿å­˜åœ¨æœ¬åœ°cookieä¸­ï¼Œæµè§ˆå™¨åœ¨ä¸‹æ¬¡ httpè¯·æ±‚çš„è¯·æ±‚å¤´ä¸­ä¼šå¸¦ä¸Šè¯¥åŸŸåä¸‹çš„cookieä¿¡æ¯ï¼Œ</li>
<li>æœåŠ¡ï¨¸åœ¨æ¥å—å®¢æˆ·ç«¯è¯·æ±‚æ—¶ä¼šè§£æè¯·æ±‚å¤´cookieä¸­çš„sidï¼Œæ ¹æ®sidå»æ‰¾æœåŠ¡ï¨¸ç«¯ä¿å­˜çš„è¯¥å®¢æˆ·ç«¯çš„sessionï¼Œä»¥æ­¤åˆ¤æ–­è¯¥è¯·æ±‚æ˜¯å¦åˆæ³•</li>
</ol>
<p>ä¸è¶³ï¼š</p>
<ol>
<li>æœåŠ¡ç«¯ä¿å­˜æœ‰çŠ¶æ€</li>
<li>APP æ²¡æœ‰ cookieï¼Œè·¨åŸŸä¸å¥½è§£å†³</li>
</ol>
</blockquote>
<pre><code class="language-js">const http = require('http')

const session = {} // ç”¨æ¥ä¿å­˜ç”¨æˆ·ä¿¡æ¯
const sessionKey = 'sid'
http
  .createServer((req, res) =&gt; {
    if (req.url === '/favicon.ico') {
      res.end('')
    }

    const cookie = req.headers.cookie

    if (cookie &amp;&amp; cookie.indexOf(sessionKey) &gt; -1) {
      // å¦‚æœ cookie ä¸­å­˜åœ¨ sessionKey
      res.end('come back')
      // å–å¾— sid
      const pattern = new RegExp(`${sessionKey}=([^;]+);?\s*`)
      const sid = pattern.exec(cookie)[1]
      // å–å¾—ç”¨æˆ·ä¿¡æ¯ï¼ˆä¿å­˜åœ¨æœåŠ¡å™¨ï¼‰
      console.log('get session', session[sid])
    } else {
      // å¦‚æœ cookie ä¸­ä¸å­˜åœ¨ sessionKey
      // è®¾ç½® sidï¼Œä¿å­˜åœ¨ cookie ä¸­
      const sid = Math.random() * 99999999
      res.setHeader('Set-Cookie', `${sessionKey}=${sid}`)
      res.end('Hi Jerry')
      // åœ¨æœåŠ¡å™¨ä¸­ä¿å­˜ sid ä¸ ç”¨æˆ·ä¿¡æ¯
      session[sid] = { name: 'Jerry' }
      console.log('set session', session[sid])
    }
  })
  .listen(3000)
</code></pre>
<h3 id="koa-ä¸­çš„å®ç°-ä½¿ç”¨ä¸­é—´ä»¶-koa-session">koa ä¸­çš„å®ç° - ä½¿ç”¨ä¸­é—´ä»¶ koa-session</h3>
<pre><code class="language-js">const Koa = require('koa')
const session = require('koa-session')

const app = new Koa()
app.keys = ['SUOIJIHIJO#U$()_IKRJIW!Q']

const SESS_CONFIG = {
  key: 'test:sess',
  maxAge: 3600000, // ms
  httpOnly: true,
  // ç­¾åï¼Œå¯¹ session ID çš„å€¼è¿›è¡Œä¸€æ¬¡ hash åŠ å¯†
  // æ¥é˜²æ­¢ä¼ªé€  cookie
  signed: true, 
}

app.use(session(SESS_CONFIG, app))

app.use((ctx) =&gt; {
  if (ctx.path === '/favicon.ico') return
  // ä» session ä¸­å–æ•°æ®
  const n = ctx.session.count || 1
  // å¾€ session ä¸­å­˜æ•°æ®
  ctx.session.count = n + 1

  ctx.body = JSON.stringify(ctx.session) + '\nç¬¬' + n + 'æ¬¡è®¿é—®'
})

app.listen(3000)
</code></pre>
<h3 id="ä½¿ç”¨-redis-å­˜å‚¨-session">ä½¿ç”¨ redis å­˜å‚¨ session</h3>
<h4 id="åŸºæœ¬ä½¿ç”¨">åŸºæœ¬ä½¿ç”¨</h4>
<pre><code class="language-js">const redis = require('redis')

const client = redis.createClient(6379, 'localhost')

client.set('hello', 'Hello, world!')

client.get('hello', (err, v) =&gt; {
  console.log('hello: ', v)
})
</code></pre>
<h4 id="åœ¨-koa-ä¸­å¼•å…¥">åœ¨ koa ä¸­å¼•å…¥</h4>
<blockquote>
<p><a href="https://github.com/NodeRedis/node_redis">node-redis æ–‡æ¡£</a></p>
</blockquote>
<pre><code class="language-js">const Koa = require('koa')
const session = require('koa-session')

const app = new Koa()
app.keys = ['SUOIJIHIJO#U$()_IKRJIW!Q']

// ä½¿ç”¨ redis å­˜å‚¨ session
const redis = require('redis')
const redisClient = redis.createClient(6379, 'localhost')
// åŒ…è£…ä¸º Promise 
const wrapper = require('co-redis')
const client = wrapper(redisClient)

const redisStore = require('koa-redis')

const SESS_CONFIG = {
  key: 'test:sess',
  maxAge: 3600000, // ms
  httpOnly: true,
  signed: true,
  // é…ç½® store
  store: redisStore({ client }),
}

app.use(session(SESS_CONFIG, app))

// è¯»å– redis
app.use(async (ctx, next) =&gt; {
  const keys = await client.keys('*')
  console.log('---------------------')
  keys.forEach(async (key) =&gt; {
    console.log(await client.get(key))
  })
  await next()
})
</code></pre>
<h2 id="token">Token</h2>
<blockquote>
<ul>
<li>ä¸ session çš„åŒºåˆ«</li>
</ul>
<p>æœåŠ¡å™¨æ˜¯æ— çŠ¶æ€çš„ã€‚Token é€šè¿‡å¯†ç å­¦æ¥è§£å†³ç”¨æˆ·è®¤è¯ï¼Œä¸éœ€è¦åœ¨æœåŠ¡ç«¯ä¿å­˜çŠ¶æ€ï¼ŒçŠ¶æ€åŠ å¯†åä¿å­˜åœ¨å®¢æˆ·ç«¯çš„ token ä¸­ã€‚æœåŠ¡ç«¯æ¥æ”¶åˆ° token åï¼Œè§£å¯†å³å¯è·å¾—çŠ¶æ€ã€‚</p>
<ul>
<li>è¿‡ç¨‹</li>
</ul>
<ol>
<li>å®¢æˆ·ç«¯ä½¿ç”¨ç”¨æˆ·åè·Ÿå¯†ç è¯·æ±‚ç™»å½•</li>
<li>æœåŠ¡ç«¯æ”¶åˆ°è¯·æ±‚ï¼ŒéªŒè¯ç”¨æˆ·åä¸å¯†ç </li>
<li>éªŒè¯æˆåŠŸåï¼ŒæœåŠ¡ç«¯ä¼šç­¾å‘ä¸€ä¸ªä»¤ç‰Œ(Token)ï¼Œå†æŠŠè¿™ä¸ª Token å‘é€ç»™å®¢æˆ·ç«¯</li>
<li>å®¢æˆ·ç«¯æ”¶åˆ° Token ä»¥åå¯ä»¥æŠŠå®ƒå­˜å‚¨èµ·æ¥ï¼Œå¦‚æ”¾åœ¨ Cookie ï§©æˆ–è€… Local Storage ï§©</li>
<li>å®¢æˆ·ç«¯æ¯æ¬¡å‘æœåŠ¡ç«¯è¯·æ±‚èµ„æºçš„æ—¶å€™éœ€è¦å¸¦ç€æœåŠ¡ç«¯ç­¾å‘çš„ Token</li>
<li>æœåŠ¡ç«¯æ”¶åˆ°è¯·æ±‚åï¼ŒéªŒè¯å®¢æˆ·ç«¯è¯·æ±‚ï§©é¢å¸¦ç€çš„ Tokenï¼Œå¦‚æœéªŒè¯æˆåŠŸï¼Œå°±å‘å®¢æˆ·ç«¯è¿”å›è¯·æ±‚çš„æ•°æ®</li>
</ol>
</blockquote>
<h3 id="jwtjson-web-token-åŸç†">JWT(JSON WEB TOKEN) åŸç†</h3>
<blockquote>
<p>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJkYXRhIjp7InVzZXJuYW1lIjoiYWRtaW4ifSwiZXhwIjoxNTkzMTczMjgwLCJpYXQiOjE1OTMxNjk2ODB9.MFAhKWPaQMdB3BjY_USoZxiB_1h72x9bjjoa0CfpkC8</p>
<ul>
<li>åŒ…å«ï¼ˆè§£å¯†åï¼‰ï¼š</li>
<li>ä»¤ç‰Œå¤´ï¼š{&quot;alg&quot;:&quot;HS256&quot;,&quot;typ&quot;:&quot;JWT&quot;}</li>
<li>payloadï¼š{&quot;data&quot;:{&quot;username&quot;:&quot;admin&quot;},&quot;exp&quot;:1593173280,&quot;iat&quot;:1593169680}</li>
<li>å“ˆå¸Œï¼šMFAhKWPaQMdB3BjY_USoZxiB_1h72x9bjjoa0CfpkC8</li>
</ul>
</blockquote>
<p>Bearer Token åŒ…å« <strong>ä»¤ç‰Œå¤´</strong>ã€<strong>payload</strong>ã€<strong>å“ˆå¸Œ</strong></p>
<ul>
<li>ç­¾åï¼š</li>
</ul>
<p>é»˜è®¤ä½¿ç”¨ base64ï¼ˆå¯é€†ï¼‰å¯¹<strong>ä»¤ç‰Œå¤´</strong>å’Œ <strong>payload</strong> è¿›è¡Œç¼–ç ï¼Œä½¿ç”¨ hs256 ç®—æ³•å¯¹<strong>ä»¤ç‰Œå¤´</strong>ã€<strong>payload</strong>å’Œ<strong>å¯†é’¥</strong>è¿›è¡Œç­¾åï¼Œç”Ÿæˆå“ˆå¸Œ</p>
<ul>
<li>éªŒè¯ï¼š</li>
</ul>
<p>é»˜è®¤ä½¿ç”¨ hs256 ç®—æ³•å¯¹ä»¤ç‰Œä¸­æ•°æ®å†æ¬¡è¿›è¡Œç­¾åï¼Œå¹¶å°†ç»“æœä¸ä»¤ç‰Œä¸­<strong>å“ˆå¸Œ</strong>æ¯”å¯¹</p>
<pre><code class="language-js">const jwt = require('jsonwebtoken')

const secret = 'PiohOJHU)#@()UJIQ@F'

const token = jwt.sign(
  {
    data: { userid: '324fw23rfwea234' },
    exp: Math.floor(Date.now() / 1000) + 60 * 60,
  },
  secret,
)

console.log('token: ', token)
console.log('è§£ç å: ', jwt.verify(token, secret))

// token:  eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJkYXRhIjp7InVzZXJpZCI6IjMyNGZ3MjNyZndlYTIzNCJ9LCJleHAiOjE1OTMxNzQ1NTcsImlhdCI6MTU5MzE3MDk1N30.ckdTTAhj88JE0N_Z8XouZd6YPneD4hJIGqVuR3c9LAU
// è§£ç å:  {
//   data: { userid: '324fw23rfwea234' },
//   exp: 1593174557,
//   iat: 1593170957
// }
</code></pre>
<h3 id="åŠ å¯†ç®—æ³•ç®€ä»‹">åŠ å¯†ç®—æ³•ç®€ä»‹</h3>
<h4 id="hmac-sha256">HMAC SHA256</h4>
<p>HMAC(Hash Message Authentication Code)ï¼Œæ•£ï¦œæ¶ˆæ¯é‰´åˆ«ç ï¼ŒåŸºäºå¯†é’¥çš„ Hash ç®—æ³•çš„è®¤è¯åè®®ã€‚æ¶ˆæ¯é‰´åˆ«ç å®ç°é‰´åˆ«çš„åŸç†ï§¤æ˜¯ï¼Œç”¨å…¬å¼€å‡½æ•°å’Œå¯†é’¥äº§ç”Ÿä¸€ä¸ªå›ºå®šé•¿åº¦çš„å€¼ä½œä¸ºè®¤è¯æ ‡è¯†ï¼Œç”¨è¿™ä¸ªæ ‡è¯†é‰´åˆ«æ¶ˆæ¯çš„å®Œæ•´æ€§ã€‚ä½¿ç”¨ä¸€ä¸ªå¯†é’¥ç”Ÿæˆä¸€ä¸ªå›ºå®šå¤§å°çš„å°æ•°æ®å—ï¼Œå³ MAC ï¼Œå¹¶å°†å…¶åŠ å…¥åˆ°æ¶ˆæ¯ä¸­ï¼Œç„¶åä¼ è¾“ã€‚æ¥æ”¶æ–¹ï§ç”¨ä¸å‘é€æ–¹å…±äº«çš„å¯†é’¥è¿›ï¨ˆé‰´åˆ«è®¤è¯ç­‰ã€‚</p>
<h4 id="base64">BASE64</h4>
<p>æŒ‰ç…§ RFC2045 çš„å®šä¹‰ï¼ŒBase64 å†…å®¹ä¼ é€ç¼–ç è¢«è®¾è®¡ç”¨æ¥æŠŠä»»æ„åºï¦œçš„ 8 ä½å­—èŠ‚æè¿°ä¸ºä¸€ç§ï¥§ï§ è¢«äººç›´æ¥è¯†åˆ«çš„å½¢å¼ã€‚ï¼ˆThe Base64 Content-Transfer-Encoding is designed to represent arbitrary sequences of octets in a form that need not be humanly readable.ï¼‰ å¸¸è§äºé‚®ä»¶ã€httpåŠ å¯†ï¼Œæˆªå–httpä¿¡æ¯ï¼Œä½ å°±ä¼šå‘ç°ç™»å½•æ“ä½œçš„ç”¨æˆ·åã€å¯†ç å­—æ®µæ˜¯é€šè¿‡BASE64ç¼–ç çš„</p>
<h4 id="beare">Beare</h4>
<p>Beareä½œä¸ºä¸€ç§è®¤è¯ç±»å‹(åŸºäºOAuth 2.0)ï¼Œä½¿ç”¨&quot;Bearer&quot;å…³é”®è¯è¿›ï¨ˆå®šä¹‰</p>
<blockquote>
<p>å‚è€ƒæ–‡æ¡£ï¼š</p>
<p><a href="https://www.npmjs.com/package/jsonwebtoken">jsonwebtoken</a>ã€<a href="https://www.npmjs.com/package/koa-jwt">koa-jwt</a></p>
<p>ï§†ä¸€å³° JWTè§£é‡Š</p>
<p>http://www.ruanyifeng.com/blog/2018/07/json_web_token-tutorial.html</p>
</blockquote>
<h2 id="oauth2å¼€æ”¾æˆæƒ">OAuth2ï¼ˆå¼€æ”¾æˆæƒï¼‰</h2>
<p>ä¸‰æ–¹ç™»å…¥ä¸»è¦åŸºäº OAuth 2.0 ã€‚OAuth åè®®ä¸ºç”¨æˆ·èµ„æºçš„æˆæƒæä¾›ï¦ºä¸€ä¸ªå®‰å…¨çš„ã€å¼€æ”¾è€Œåˆç®€ï§ çš„æ ‡å‡†ã€‚ä¸ä»¥å¾€çš„æˆæƒæ–¹å¼ï¥§åŒä¹‹å¤„æ˜¯ OAuth çš„æˆæƒï¥§ä¼šä½¿ç¬¬ä¸‰æ–¹è§¦åŠåˆ°ç”¨æˆ·çš„å¸å·ä¿¡æ¯ ï¼ˆå¦‚ç”¨æˆ·åä¸å¯†ç ï¼‰ï¼Œå³ç¬¬ä¸‰æ–¹æ— éœ€ä½¿ç”¨ç”¨æˆ·çš„ç”¨æˆ·åä¸å¯†ç å°±å¯ä»¥ç”³è¯·è·å¾—è¯¥ç”¨æˆ·èµ„æºçš„æˆæƒï¼Œ å› æ­¤ OAuth æ˜¯å®‰å…¨çš„</p>
<figure data-type="image" tabindex="1"><img src="https://yuufen.com/blog/post-images/1593174881084.png" alt="OAuth" loading="lazy"></figure>
<h2 id="sso">SSO</h2>
<blockquote>
<p>å›¾ä¸­æ¯ä¸ªæœåŠ¡ç«¯éƒ½æœ‰å¯¹åº”å®¢æˆ·ç«¯ã€‚åº”ç”¨ B è½¬è·³è®¤è¯é¡µæ—¶ï¼Œè¿›å…¥è®¤è¯æœåŠ¡å™¨å¯¹åº”å®¢æˆ·ç«¯çš„åŸŸï¼Œæ­¤æ—¶å¯è®¿é—®åˆ°æœ¬åœ°çš„ç”¨æˆ·ä»¤ç‰Œã€‚å°†ç”¨æˆ·ä»¤ç‰Œå‘é€è‡³è®¤è¯æœåŠ¡å™¨ï¼Œå¯éªŒè¯ç”¨æˆ·æ˜¯å¦å·²ç™»å½•ã€‚</p>
</blockquote>
<figure data-type="image" tabindex="2"><img src="https://yuufen.com/blog/post-images/1593176304739.png" alt="" loading="lazy"></figure>
<figure data-type="image" tabindex="3"><img src="https://yuufen.com/blog/post-images/1593176308834.png" alt="" loading="lazy"></figure>
<h2 id="demo">DEMO</h2>
<h3 id="session-cookie-2">Session - Cookie</h3>
<pre><code class="language-html">&lt;html&gt;
  &lt;head&gt;
    &lt;script src=&quot;https://cdn.jsdelivr.net/npm/vue/dist/vue.js&quot;&gt;&lt;/script&gt;
    &lt;script src=&quot;https://unpkg.com/axios/dist/axios.min.js&quot;&gt;&lt;/script&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div id=&quot;app&quot;&gt;
      &lt;div&gt;
        &lt;input v-model=&quot;username&quot; /&gt;
        &lt;input v-model=&quot;password&quot; /&gt;
      &lt;/div&gt;
      &lt;div&gt;
        &lt;button v-on:click=&quot;login&quot;&gt;Login&lt;/button&gt;
        &lt;button v-on:click=&quot;logout&quot;&gt;Logout&lt;/button&gt;
        &lt;button v-on:click=&quot;getUser&quot;&gt;GetUser&lt;/button&gt;
      &lt;/div&gt;
      &lt;div&gt;
        &lt;button onclick=&quot;document.getElementById('log').innerHTML = ''&quot;&gt;Clear Log&lt;/button&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;h6 id=&quot;log&quot;&gt;&lt;/h6&gt;
    &lt;script&gt;
      // axios.defaults.baseURL = 'http://localhost:3000'
      axios.defaults.withCredentials = true
      axios.interceptors.response.use((response) =&gt; {
        document.getElementById('log').append(JSON.stringify(response.data))
        return response
      })
      var app = new Vue({
        el: '#app',
        data: { username: 'test', password: 'test' },
        methods: {
          async login() {
            await axios.post('/users/login', {
              username: this.username,

              password: this.password,
            })
          },
          async logout() {
            await axios.post('/users/logout')
          },
          async getUser() {
            await axios.get('/users/getUser')
          },
        },
      })
    &lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>
<pre><code class="language-js">const Koa = require('koa')
const router = require('koa-router')()
const session = require('koa-session')
const cors = require('koa2-cors')
const bodyParser = require('koa-bodyparser')
const static = require('koa-static')

const app = new Koa()
app.keys = ['F#ERF#!RQAWDQKLTJ#@QOP']

app.use(cors({ credentials: true }))
app.use(static(__dirname + '/'))
app.use(bodyParser())

app.use(session(app)) // è¿™é‡Œç»™ ctx æŒ‚ä¸Šäº† session å±æ€§

app.use((ctx, next) =&gt; {
  if (ctx.url.indexOf('login') &gt; -1) {
    next()
  } else {
    if (ctx.session.userinfo) {
      next()
    } else {
      ctx.body = { message: 'æœªç™»å½•' }
    }
  }
})

router.post('/users/login', async (ctx) =&gt; {
  const { body } = ctx.request
  // å¿½ç•¥äº†è®¤è¯è¿‡ç¨‹
  // è®¾ç½® session
  ctx.session.userinfo = body.username
  ctx.body = { message: 'ç™»å½•æˆåŠŸ' }
})

router.post('/users/logout', async (ctx) =&gt; {
  // è®¾ç½® session
  delete ctx.session.userinfo
  ctx.body = { message: 'ç™»å‡ºæˆåŠŸ' }
})

router.get('/users/getUser', async (ctx) =&gt; {
  ctx.body = {
    message:'è·å–æ•°æ®æˆåŠŸ',
    userinfo: ctx.session.userinfo
  }
})

app.use(router.routes())
app.use(router.allowedMethods())

app.listen(3000)
</code></pre>
<h3 id="token-2">Token</h3>
<pre><code class="language-html">&lt;html&gt;
  &lt;head&gt;
    &lt;script src=&quot;https://cdn.jsdelivr.net/npm/vue/dist/vue.js&quot;&gt;&lt;/script&gt;
    &lt;script src=&quot;https://unpkg.com/axios/dist/axios.min.js&quot;&gt;&lt;/script&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div id=&quot;app&quot;&gt;
      &lt;div&gt;&lt;input v-model=&quot;username&quot; /&gt; &lt;input v-model=&quot;password&quot; /&gt;&lt;/div&gt;
      &lt;div&gt;
        &lt;button v-on:click=&quot;login&quot;&gt;Login&lt;/button&gt; &lt;button v-on:click=&quot;logout&quot;&gt;Logout&lt;/button&gt;
        &lt;button v-on:click=&quot;getUser&quot;&gt;GetUser&lt;/button&gt;
      &lt;/div&gt;
      &lt;div&gt;&lt;button @click=&quot;logs=[]&quot;&gt;Clear Log&lt;/button&gt;&lt;/div&gt;
      &lt;!-- æ—¥å¿— --&gt;
      &lt;ul&gt;
        &lt;li v-for=&quot;(log,idx) in logs&quot; :key=&quot;idx&quot;&gt;{{ log }}&lt;/li&gt;
      &lt;/ul&gt;
    &lt;/div&gt;

    &lt;script&gt;
      axios.interceptors.request.use(
        (config) =&gt; {
          const token = window.localStorage.getItem('token')
          if (token) {
            // åˆ¤æ–­æ˜¯å¦å­˜åœ¨tokenï¼Œå¦‚æœå­˜åœ¨çš„è¯ï¼Œåˆ™æ¯ä¸ªhttp headeréƒ½åŠ ä¸Štoken
            // Beareræ˜¯JWTçš„è®¤è¯å¤´éƒ¨ä¿¡æ¯
            config.headers.common['Authorization'] = 'Bearer ' + token
          }
          return config
        },
        (err) =&gt; {
          return Promise.reject(err)
        },
      )
      axios.interceptors.response.use(
        (response) =&gt; {
          app.logs.push(JSON.stringify(response.data))
          return response
        },
        (err) =&gt; {
          app.logs.push(JSON.stringify(response.data))
          return Promise.reject(err)
        },
      )
      var app = new Vue({
        el: '#app',
        data: { username: 'test', password: 'test', logs: [] },
        methods: {
          login: async function () {
            const res = await axios.post('/users/login-token', { username: this.username, password: this.password })
            localStorage.setItem('token', res.data.token)
          },
          logout: async function () {
            localStorage.removeItem('token')
          },
          getUser: async function () {
            await axios.get('/users/getUser-token')
          },
        },
      })
    &lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>
<pre><code class="language-js">const Koa = require('koa')
const router = require('koa-router')()
const jwt = require('jsonwebtoken')
const jwtAuth = require('koa-jwt')
const secret = &quot;it's a secret&quot;
const cors = require('koa2-cors')
const bodyParser = require('koa-bodyparser')
const static = require('koa-static')

const app = new Koa()
app.keys = ['ROI#HRF)PQHAYR@!()U!Q']

app.use(static(__dirname + '/'))
app.use(bodyParser())

router.post('/users/login-token', async (ctx) =&gt; {
  const { body } = ctx.request //ç™»å½•é€»è¾‘ï¼Œç•¥ï¥¶
  // ä¸€èˆ¬ username ä¹Ÿä¸èƒ½æš´éœ²åœ¨ token ä¸­
  const userinfo = body.username
  ctx.body = {
    message: 'ç™»å½•æˆåŠŸ',
    user: userinfo,
    // ç”Ÿæˆ token è¿”å›ç»™å®¢æˆ·ç«¯
    token: jwt.sign(
      {
        data: userinfo,
        // è®¾ç½® token è¿‡æœŸæ—¶é—´ï¼Œä¸€å°æ—¶åï¼Œç§’ä¸ºå•ä½
        exp: Math.floor(Date.now() / 1000) + 60 * 60,
      },
      secret,
    ),
  }
})

router.get(
  '/users/getUser-token',
  // é‰´æƒä¸­é—´ä»¶ã€‚éªŒè¯ hash ä»¥åŠæ˜¯å¦è¿‡æœŸ
  // ä¼šå°† token ä¸­ payload æŒ‚è½½åœ¨ ctx.state.user ä¸Š
  jwtAuth({
    secret,
  }),
  async (ctx) =&gt; {
    // éªŒè¯é€šè¿‡ï¼Œstate.user
    console.log(ctx.state.user)
    ctx.body = {
      message: 'è·å–æ•°æ®æˆåŠŸ',
      userinfo: ctx.state.user.data,
    }
  },
)

app.use(router.routes())
app.use(router.allowedMethods())

app.listen(3000)
</code></pre>
<h3 id="oauth2">OAuth2</h3>
<pre><code class="language-html">&lt;html&gt;
  &lt;head&gt;
    &lt;script src=&quot;https://cdn.jsdelivr.net/npm/vue/dist/vue.js&quot;&gt;&lt;/script&gt;
    &lt;script src=&quot;https://unpkg.com/axios/dist/axios.min.js&quot;&gt;&lt;/script&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div id=&quot;app&quot;&gt;&lt;a href=&quot;/github/login&quot;&gt;login with github&lt;/a&gt;&lt;/div&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>
<pre><code class="language-js">const Koa = require('koa')
const router = require('koa-router')()
const static = require('koa-static')

const app = new Koa()
const axios = require('axios')
const querystring = require('querystring')

app.use(static(__dirname + '/'))

// GitHub App ä¿¡æ¯
const config = {
  client_id: '73a4f730f2e8cf7d5fcf',
  client_secret: '74bde1aec977bd93ac4eb8f7ab63352dbe03ce48',
}

router.get('/github/login', async (ctx) =&gt; {
  const dataStr = new Date().valueOf()

  //é‡å®šå‘åˆ°è®¤è¯æ¥å£,å¹¶é…ç½®å‚æ•°
  let path = 'https://github.com/login/oauth/authorize'
  path += '?client_id=' + config.client_id

  //è½¬å‘åˆ°æˆæƒæœåŠ¡ï¨¸
  ctx.redirect(path)
})

// å›è°ƒï¼Œä¼ å…¥è®¤è¯ code
router.get('/github/callback', async (ctx) =&gt; {
  console.log('callback..')

  const code = ctx.query.code

  const params = {
    client_id: config.client_id,
    client_secret: config.client_secret,
    code: code,
  }
  // ç”¨ code ç”³è¯· token ä»¤ç‰Œ
  let res = await axios.post('https://github.com/login/oauth/access_token', params)
  const access_token = querystring.parse(res.data).access_token

  // ç”¨ token ä»¤ç‰Œè¯·æ±‚ç”¨æˆ·ä¿¡æ¯
  res = await axios.get('https://api.github.com/user?access_token=' + access_token)
  console.log('userAccess:', res.data)
  ctx.body = `
    &lt;h1&gt;Hello ${res.data.login}&lt;/h1&gt;
    &lt;img src=&quot;${res.data.avatar_url}&quot; alt=&quot;&quot;/&gt;    
  `
})

app.use(router.routes())
app.use(router.allowedMethods())
app.listen(3000)
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[MongoDB æ•°æ®åº“è®¾è®¡ä¸­ 6 æ¡é‡è¦çš„ç»éªŒæ³•åˆ™]]></title>
        <id>https://yuufen.com/blog/post/fRNVUf6Jn/</id>
        <link href="https://yuufen.com/blog/post/fRNVUf6Jn/">
        </link>
        <updated>2020-06-25T09:49:07.000Z</updated>
        <content type="html"><![CDATA[<h2 id="part-1">Part 1</h2>
<p>åŸæ–‡ï¼š<a href="http://blog.mongodb.org/post/87200945828/6-rules-of-thumb-for-mongodb-schema-design-part-1">6 Rules of Thumb for MongoDB Schema Design: Part 1</a></p>
<p><em>By William Zola, Lead Technical Support Engineer at MongoDB</em></p>
<p>â€œæˆ‘æœ‰ä¸°å¯Œçš„sqlä½¿ç”¨ç»éªŒï¼Œä½†æ˜¯æˆ‘æ˜¯ä¸ªMongoDBçš„åˆå­¦è€…ã€‚æˆ‘åº”è¯¥å¦‚ä½•åœ¨MongoDBä¸­é’ˆå¯¹ä¸€å¯¹å¤šå…³ç³»è¿›è¡Œå»ºæ¨¡ï¼Ÿâ€è¿™æ˜¯æˆ‘è¢«é—®åŠæœ€å¤šçš„é—®é¢˜ä¹‹ä¸€ã€‚</p>
<p>æˆ‘æ²¡æ³•ç®€å•çš„ç»™å‡ºç­”æ¡ˆï¼Œå› ä¸ºè¿™æœ‰å¾ˆå¤šæ–¹æ¡ˆå»å®ç°ã€‚æ¥ä¸‹æ¥æˆ‘ä¼šæ•™å¯¼ä½ å¦‚ä½•é’ˆå¯¹ä¸€å¯¹å¤šè¿›è¡Œå»ºæ¨¡ã€‚</p>
<p>è¿™ä¸ªè¯é¢˜æœ‰å¾ˆå¤šå†…å®¹éœ€è¦è®¨è®ºï¼Œæˆ‘ä¼šç”¨ä¸‰ä¸ªéƒ¨åˆ†è¿›è¡Œè¯´æ˜ã€‚åœ¨ç¬¬ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä¼šè®¨è®ºé’ˆå¯¹ä¸€å¯¹å¤šå…³ç³»å»ºæ¨¡çš„ä¸‰ç§åŸºç¡€æ–¹æ¡ˆã€‚åœ¨ç¬¬äºŒéƒ¨åˆ†æˆ‘å°†ä¼šè¦†ç›–æ›´å¤šé«˜çº§å†…å®¹ï¼ŒåŒ…æ‹¬åèŒƒå¼åŒ–å’ŒåŒå‘å¼•ç”¨ã€‚åœ¨æœ€åä¸€éƒ¨åˆ†ï¼Œæˆ‘å°†ä¼šå›é¡¾å„ç§é€‰æ‹©ï¼Œå¹¶ç»™å‡ºåšå†³å®šæ—¶éœ€è¦è€ƒè™‘çš„å› ç´ ã€‚</p>
<p>å¾ˆå¤šåˆå­¦è€…è®¤ä¸ºåœ¨MongoDBä¸­é’ˆå¯¹ä¸€å¯¹å¤šå»ºæ¨¡å”¯ä¸€çš„æ–¹æ¡ˆå°±æ˜¯åœ¨çˆ¶æ–‡æ¡£ä¸­å†…åµŒä¸€ä¸ªæ•°ç»„å­æ–‡æ¡£ï¼Œä½†æ˜¯è¿™æ˜¯ä¸å‡†ç¡®çš„ã€‚å› ä¸ºä½ å¯ä»¥åœ¨MongoDBå†…åµŒä¸€ä¸ªæ–‡æ¡£ä¸ä»£è¡¨ä½ å°±å¿…é¡»è¿™ä¹ˆåšã€‚</p>
<p>å½“ä½ è®¾è®¡ä¸€ä¸ªMongoDBæ•°æ®åº“ç»“æ„ï¼Œä½ éœ€è¦å…ˆé—®è‡ªå·±ä¸€ä¸ªåœ¨ä½¿ç”¨å…³ç³»å‹æ•°æ®åº“æ—¶ä¸ä¼šè€ƒè™‘çš„é—®é¢˜ï¼šè¿™ä¸ªå…³ç³»ä¸­é›†åˆçš„å¤§å°æ˜¯ä»€ä¹ˆæ ·çš„è§„æ¨¡ï¼Ÿä½ éœ€è¦æ„è¯†åˆ°ä¸€å¯¹å¾ˆå°‘ï¼Œä¸€å¯¹è®¸å¤šï¼Œä¸€å¯¹éå¸¸å¤šï¼Œè¿™äº›ç»†å¾®çš„åŒºåˆ«ã€‚ä¸åŒçš„æƒ…å†µä¸‹ä½ çš„å»ºæ¨¡ä¹Ÿå°†ä¸åŒã€‚</p>
<p><em>Basics: Modeling One-to-Few</em></p>
<h3 id="ä¸€å¯¹å¾ˆå°‘">ä¸€å¯¹å¾ˆå°‘</h3>
<p>é’ˆå¯¹ä¸ªäººéœ€è¦ä¿å­˜å¤šä¸ªåœ°å€è¿›è¡Œå»ºæ¨¡çš„åœºæ™¯ä¸‹ä½¿ç”¨å†…åµŒæ–‡æ¡£æ˜¯å¾ˆåˆé€‚ï¼Œå¯ä»¥åœ¨personæ–‡æ¡£ä¸­åµŒå…¥addressesæ•°ç»„æ–‡æ¡£ï¼š</p>
<figure data-type="image" tabindex="1"><img src="https://images2015.cnblogs.com/blog/298288/201512/298288-20151229110634292-485259216.png" alt="img" loading="lazy"></figure>
<p>è¿™ç§è®¾è®¡å…·æœ‰å†…åµŒæ–‡æ¡£è®¾è®¡ä¸­æ‰€æœ‰çš„ä¼˜ç¼ºç‚¹ã€‚æœ€ä¸»è¦çš„ä¼˜ç‚¹å°±æ˜¯ä¸éœ€è¦å•ç‹¬æ‰§è¡Œä¸€æ¡è¯­å¥å»è·å–å†…åµŒçš„å†…å®¹ã€‚æœ€ä¸»è¦çš„ç¼ºç‚¹æ˜¯ä½ æ— æ³•æŠŠè¿™äº›å†…åµŒæ–‡æ¡£å½“åšå•ç‹¬çš„å®ä½“å»è®¿é—®ã€‚</p>
<p>ä¾‹å¦‚ï¼Œå¦‚æœä½ æ˜¯åœ¨å¯¹ä¸€ä¸ªä»»åŠ¡è·Ÿè¸ªç³»ç»Ÿè¿›è¡Œå»ºæ¨¡ï¼Œæ¯ä¸ªç”¨æˆ·å°†ä¼šè¢«åˆ†é…è‹¥å¹²ä¸ªä»»åŠ¡ã€‚å†…åµŒè¿™äº›ä»»åŠ¡åˆ°ç”¨æˆ·æ–‡æ¡£åœ¨é‡åˆ°â€œæŸ¥è¯¢æ˜¨å¤©æ‰€æœ‰çš„ä»»åŠ¡â€è¿™æ ·çš„é—®é¢˜æ—¶å°†ä¼šéå¸¸å›°éš¾ã€‚æˆ‘ä¼šåœ¨ä¸‹ä¸€ç¯‡æ–‡ç« é’ˆå¯¹è¿™ä¸ªç”¨ä¾‹æä¾›ä¸€äº›é€‚å½“çš„è®¾è®¡ã€‚</p>
<p><em>Basics: One-to-Many</em></p>
<h3 id="ä¸€å¯¹è®¸å¤š">ä¸€å¯¹è®¸å¤š</h3>
<p>ä»¥äº§å“é›¶ä»¶è®¢è´§ç³»ç»Ÿä¸ºä¾‹ã€‚æ¯ä¸ªå•†å“æœ‰æ•°ç™¾ä¸ªå¯æ›¿æ¢çš„é›¶ä»¶ï¼Œä½†æ˜¯ä¸ä¼šè¶…è¿‡æ•°åƒä¸ªã€‚è¿™ä¸ªç”¨ä¾‹å¾ˆé€‚åˆä½¿ç”¨é—´æ¥å¼•ç”¨---å°†é›¶ä»¶çš„objectidä½œä¸ºæ•°ç»„å­˜æ”¾åœ¨å•†å“æ–‡æ¡£ä¸­(åœ¨è¿™ä¸ªä¾‹å­ä¸­çš„ObjectIDæˆ‘ä½¿ç”¨æ›´åŠ æ˜“è¯»çš„2å­—èŠ‚ï¼Œç°å®ä¸–ç•Œä¸­ä»–ä»¬å¯èƒ½æ˜¯ç”±12ä¸ªå­—èŠ‚ç»„æˆçš„)ã€‚</p>
<p>æ¯ä¸ªé›¶ä»¶éƒ½å°†æœ‰ä»–ä»¬è‡ªå·±çš„æ–‡æ¡£å¯¹è±¡</p>
<figure data-type="image" tabindex="2"><img src="https://images2015.cnblogs.com/blog/298288/201512/298288-20151229110759823-711319082.png" alt="img" loading="lazy"></figure>
<p>æ¯ä¸ªäº§å“çš„æ–‡æ¡£å¯¹è±¡ä¸­partsæ•°ç»„ä¸­å°†ä¼šå­˜æ”¾å¤šä¸ªé›¶ä»¶çš„ObjectID ï¼š</p>
<figure data-type="image" tabindex="3"><img src="https://images2015.cnblogs.com/blog/298288/201512/298288-20151229110817167-843655174.png" alt="img" loading="lazy"></figure>
<p>åœ¨è·å–ç‰¹å®šäº§å“ä¸­æ‰€æœ‰é›¶ä»¶ï¼Œéœ€è¦ä¸€ä¸ªåº”ç”¨å±‚çº§åˆ«çš„join</p>
<p>ä¸ºäº†èƒ½å¿«é€Ÿçš„æ‰§è¡ŒæŸ¥è¯¢ï¼Œå¿…é¡»ç¡®ä¿products.catalog_numberæœ‰ç´¢å¼•ã€‚å½“ç„¶ç”±äºé›¶ä»¶ä¸­parts._idä¸€å®šæ˜¯æœ‰ç´¢å¼•çš„ï¼Œæ‰€ä»¥è¿™ä¹Ÿä¼šå¾ˆé«˜æ•ˆã€‚</p>
<p>è¿™ç§å¼•ç”¨çš„æ–¹å¼æ˜¯å¯¹å†…åµŒä¼˜ç¼ºç‚¹çš„è¡¥å……ã€‚æ¯ä¸ªé›¶ä»¶æ˜¯ä¸ªå•ç‹¬çš„æ–‡æ¡£ï¼Œå¯ä»¥å¾ˆå®¹æ˜“çš„ç‹¬ç«‹å»æœç´¢å’Œæ›´æ–°ä»–ä»¬ã€‚éœ€è¦ä¸€æ¡å•ç‹¬çš„è¯­å¥å»è·å–é›¶ä»¶çš„å…·ä½“å†…å®¹æ˜¯ä½¿ç”¨è¿™ç§å»ºæ¨¡æ–¹å¼éœ€è¦è€ƒè™‘çš„ä¸€ä¸ªé—®é¢˜ï¼ˆè¯·ä»”ç»†æ€è€ƒè¿™ä¸ªé—®é¢˜ï¼Œåœ¨ç¬¬äºŒç« ååèŒƒå¼åŒ–ä¸­ï¼Œæˆ‘ä»¬è¿˜ä¼šè®¨è®ºè¿™ä¸ªé—®é¢˜ï¼‰</p>
<p>è¿™ç§å»ºæ¨¡æ–¹å¼ä¸­çš„é›¶ä»¶éƒ¨åˆ†å¯ä»¥è¢«å¤šä¸ªäº§å“ä½¿ç”¨ï¼Œæ‰€ä»¥åœ¨å¤šå¯¹å¤šæ—¶ä¸éœ€è¦ä¸€å¼ å•ç‹¬çš„è¿æ¥è¡¨ã€‚</p>
<p><em>Basics: One-to-Squillions</em></p>
<h3 id="ä¸€å¯¹éå¸¸å¤š">ä¸€å¯¹éå¸¸å¤š</h3>
<p>æˆ‘ä»¬ç”¨ä¸€ä¸ªæ”¶é›†å„ç§æœºå™¨æ—¥å¿—çš„ä¾‹å­æ¥è®¨è®ºä¸€å¯¹éå¸¸å¤šçš„é—®é¢˜ã€‚ç”±äºæ¯ä¸ªmongodbçš„æ–‡æ¡£æœ‰16Mçš„å¤§å°é™åˆ¶ï¼Œæ‰€ä»¥å³ä½¿ä½ æ˜¯å­˜å‚¨ObjectIDä¹Ÿæ˜¯ä¸å¤Ÿçš„ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¾ˆç»å…¸çš„å¤„ç†æ–¹æ³•â€œçˆ¶çº§å¼•ç”¨â€---ç”¨ä¸€ä¸ªæ–‡æ¡£å­˜å‚¨ä¸»æœºï¼Œåœ¨æ¯ä¸ªæ—¥å¿—æ–‡æ¡£ä¸­ä¿å­˜è¿™ä¸ªä¸»æœºçš„ObjectIDã€‚</p>
<figure data-type="image" tabindex="4"><img src="https://images2015.cnblogs.com/blog/298288/201512/298288-20151229111030651-395125605.png" alt="img" loading="lazy"></figure>
<p>ä»¥ä¸‹æ˜¯ä¸ªå’Œç¬¬äºŒä¸­æ–¹æ¡ˆç¨å¾®ä¸åŒçš„åº”ç”¨çº§åˆ«çš„joinç”¨æ¥æŸ¥æ‰¾ä¸€å°ä¸»æœºæœ€è¿‘5000æ¡çš„æ—¥å¿—ä¿¡æ¯</p>
<figure data-type="image" tabindex="5"><img src="https://images2015.cnblogs.com/blog/298288/201512/298288-20151229111059635-1509238621.png" alt="img" loading="lazy"></figure>
<p>æ‰€ä»¥ï¼Œå³ä½¿è¿™ç§ç®€å•çš„è®¨è®ºä¹Ÿæœ‰èƒ½å¯Ÿè§‰å‡ºmongobdçš„å»ºæ¨¡å’Œå…³ç³»æ¨¡å‹å»ºæ¨¡çš„ä¸åŒä¹‹å¤„ã€‚ä½ å¿…é¡»è¦æ³¨æ„ä¸€ä¸‹ä¸¤ä¸ªå› ç´ ï¼š</p>
<p><em>Will the entities on the â€œNâ€ side of the One-to-N ever need to stand alone?</em></p>
<p>ä¸€å¯¹å¤šä¸­çš„å¤šæ˜¯å¦éœ€è¦ä¸€ä¸ªå•ç‹¬çš„å®ä½“ã€‚</p>
<p><em>What is the cardinality of the relationship: is it one-to-few; one-to-many; or one-to-squillions?</em></p>
<p>è¿™ä¸ªå…³ç³»ä¸­é›†åˆçš„è§„æ¨¡æ˜¯ä¸€å¯¹å¾ˆå°‘ï¼Œå¾ˆå¤šï¼Œè¿˜æ˜¯éå¸¸å¤šã€‚</p>
<p><em>Based on these factors, you can pick one of the three basic One-to-N schema designs:</em></p>
<p>åŸºäºä»¥ä¸Šå› ç´ æ¥å†³å®šé‡‡å–ä¸€ä¸‹ä¸‰ç§å»ºæ¨¡çš„æ–¹å¼</p>
<p><em><strong>ä¸€å¯¹å¾ˆå°‘ä¸”ä¸éœ€è¦å•ç‹¬è®¿é—®å†…åµŒå†…å®¹çš„æƒ…å†µä¸‹å¯ä»¥ä½¿ç”¨å†…åµŒå¤šçš„ä¸€æ–¹ã€‚</strong></em></p>
<p><em><strong>ä¸€å¯¹å¤šä¸”å¤šçš„ä¸€ç«¯å†…å®¹å› ä¸ºå„ç§ç†ç”±éœ€è¦å•ç‹¬å­˜åœ¨çš„æƒ…å†µä¸‹å¯ä»¥é€šè¿‡æ•°ç»„çš„æ–¹å¼å¼•ç”¨å¤šçš„ä¸€æ–¹çš„ã€‚</strong></em></p>
<p><em><strong>ä¸€å¯¹éå¸¸å¤šçš„æƒ…å†µä¸‹ï¼Œè¯·å°†ä¸€çš„é‚£ç«¯å¼•ç”¨åµŒå…¥è¿›å¤šçš„ä¸€ç«¯å¯¹è±¡ä¸­ã€‚</strong></em></p>
<h2 id="part-2">Part 2</h2>
<p><strong>åŸæ–‡ï¼š<a href="http://blog.mongodb.org/post/87892923503/6-rules-of-thumb-for-mongodb-schema-design-part-2">6 Rules of Thumb for MongoDB Schema Design: Part 2</a></strong></p>
<p><em>By William Zola, Lead Technical Support Engineer at MongoDB</em></p>
<p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æˆ‘ä»‹ç»äº†ä¸‰ç§åŸºæœ¬çš„è®¾è®¡æ–¹æ¡ˆï¼šå†…åµŒï¼Œå­å¼•ç”¨ï¼Œçˆ¶å¼•ç”¨ï¼ŒåŒæ—¶è¯´æ˜äº†åœ¨é€‰æ‹©æ–¹æ¡ˆæ—¶éœ€è¦è€ƒè™‘çš„ä¸¤ä¸ªå…³é”®å› ç´ ã€‚</p>
<p>ä¸€å¯¹å¤šä¸­çš„å¤šæ˜¯å¦éœ€è¦ä¸€ä¸ªå•ç‹¬çš„å®ä½“ã€‚</p>
<p>è¿™ä¸ªå…³ç³»ä¸­é›†åˆçš„è§„æ¨¡æ˜¯ä¸€å¯¹å¾ˆå°‘ï¼Œå¾ˆå¤šï¼Œè¿˜æ˜¯éå¸¸å¤šã€‚</p>
<p>åœ¨æŒæ¡äº†ä»¥ä¸ŠåŸºç¡€æŠ€æœ¯åï¼Œæˆ‘å°†ä¼šä»‹ç»æ›´ä¸ºé«˜çº§çš„ä¸»é¢˜ï¼š<strong>åŒå‘å…³è”</strong>å’Œ<strong>åèŒƒå¼åŒ–</strong>ã€‚</p>
<h3 id="åŒå‘å…³è”">åŒå‘å…³è”</h3>
<p>å¦‚æœä½ æƒ³è®©ä½ çš„è®¾è®¡æ›´é…·ï¼Œä½ å¯ä»¥è®©å¼•ç”¨çš„â€œoneâ€ç«¯å’Œâ€œmanyâ€ç«¯åŒæ—¶ä¿å­˜å¯¹æ–¹çš„å¼•ç”¨ã€‚</p>
<p>ä»¥ä¸Šä¸€ç¯‡æ–‡ç« è®¨è®ºè¿‡çš„ä»»åŠ¡è·Ÿè¸ªç³»ç»Ÿä¸ºä¾‹ã€‚æœ‰personå’Œtaskä¸¤ä¸ªé›†åˆï¼Œone-to-nçš„å…³ç³»æ˜¯ä»personç«¯åˆ°taskç«¯ã€‚åœ¨éœ€è¦è·å–personæ‰€æœ‰çš„taskè¿™ä¸ªåœºæ™¯ä¸‹éœ€è¦åœ¨personè¿™ä¸ªå¯¹è±¡ä¸­ä¿å­˜æœ‰taskçš„idæ•°ç»„ï¼Œå¦‚ä¸‹é¢ä»£ç æ‰€ç¤ºã€‚</p>
<figure data-type="image" tabindex="6"><img src="https://images2015.cnblogs.com/blog/298288/201512/298288-20151229111342276-1359236117.png" alt="img" loading="lazy"></figure>
<p>åœ¨æŸäº›åœºæ™¯ä¸­è¿™ä¸ªåº”ç”¨éœ€è¦æ˜¾ç¤ºä»»åŠ¡çš„åˆ—è¡¨ï¼ˆä¾‹å¦‚æ˜¾ç¤ºä¸€ä¸ªå¤šäººåä½œé¡¹ç›®ä¸­æ‰€æœ‰çš„ä»»åŠ¡ï¼‰ï¼Œä¸ºäº†èƒ½å¤Ÿå¿«é€Ÿçš„è·å–æŸä¸ªç”¨æˆ·è´Ÿè´£çš„é¡¹ç›®å¯ä»¥åœ¨taskå¯¹è±¡ä¸­åµŒå…¥é™„åŠ çš„personå¼•ç”¨å…³ç³»ã€‚</p>
<figure data-type="image" tabindex="7"><img src="https://images2015.cnblogs.com/blog/298288/201512/298288-20151229111408260-7741794.png" alt="img" loading="lazy"></figure>
<p>è¿™ä¸ªæ–¹æ¡ˆå…·æœ‰æ‰€æœ‰çš„ä¸€å¯¹å¤šæ–¹æ¡ˆçš„ä¼˜ç¼ºç‚¹ï¼Œä½†æ˜¯é€šè¿‡æ·»åŠ é™„åŠ çš„å¼•ç”¨å…³ç³»ã€‚åœ¨taskæ–‡æ¡£å¯¹è±¡ä¸­æ·»åŠ é¢å¤–çš„â€œownerâ€å¼•ç”¨å¯ä»¥å¾ˆå¿«çš„æ‰¾åˆ°æŸä¸ªtaskçš„æ‰€æœ‰è€…ï¼Œä½†æ˜¯å¦‚æœæƒ³å°†ä¸€ä¸ªtaskåˆ†é…ç»™å…¶ä»–personå°±éœ€è¦æ›´æ–°å¼•ç”¨ä¸­çš„personå’Œtaskè¿™ä¸¤ä¸ªå¯¹è±¡ï¼ˆç†Ÿæ‚‰å…³ç³»æ•°æ®åº“çš„ç«¥é‹ä¼šå‘ç°è¿™æ ·å°±æ²¡æ³•ä¿è¯æ“ä½œçš„åŸå­æ€§ã€‚å½“ç„¶ï¼Œè¿™å¯¹ä»»åŠ¡è·Ÿè¸ªç³»ç»Ÿæ¥è¯´å¹¶æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯ä½ å¿…é¡»è€ƒè™‘ä½ çš„ç”¨ä¾‹æ˜¯å¦èƒ½å¤Ÿå®¹å¿ï¼‰</p>
<h3 id="åœ¨ä¸€å¯¹å¤šå…³ç³»ä¸­åº”ç”¨åèŒƒå¼">åœ¨ä¸€å¯¹å¤šå…³ç³»ä¸­åº”ç”¨åèŒƒå¼</h3>
<p>åœ¨ä½ çš„è®¾è®¡ä¸­åŠ å…¥åèŒƒå¼ï¼Œå¯ä»¥ä½¿ä½ é¿å…åº”ç”¨å±‚çº§åˆ«çš„joinè¯»å–ï¼Œå½“ç„¶ï¼Œä»£ä»·æ˜¯è¿™ä¹Ÿä¼šè®©ä½ åœ¨æ›´æ–°æ˜¯éœ€è¦æ“ä½œæ›´å¤šæ•°æ®ã€‚ä¸‹é¢æˆ‘ä¼šä¸¾ä¸ªä¾‹å­æ¥è¿›è¡Œè¯´æ˜</p>
<h4 id="åèŒƒå¼many-one">åèŒƒå¼Many -&lt; One</h4>
<p>ä»¥äº§å“å’Œé›¶ä»¶ä¸ºä¾‹ï¼Œä½ å¯ä»¥åœ¨partsæ•°ç»„ä¸­å†—ä½™å­˜å‚¨é›¶ä»¶çš„åå­—ã€‚ä»¥ä¸‹æ˜¯æ²¡æœ‰åŠ å…¥åèŒƒå¼è®¾è®¡çš„ç»“æ„ã€‚</p>
<figure data-type="image" tabindex="8"><img src="https://images2015.cnblogs.com/blog/298288/201512/298288-20151229111528198-444946874.png" alt="img" loading="lazy"></figure>
<p>åèŒƒå¼åŒ–æ„å‘³ç€ä½ ä¸éœ€è¦æ‰§è¡Œä¸€ä¸ªåº”ç”¨å±‚çº§åˆ«çš„joinå»æ˜¾ç¤ºä¸€ä¸ªäº§å“æ‰€æœ‰çš„é›¶ä»¶åå­—ï¼Œå½“ç„¶å¦‚æœä½ åŒæ—¶è¿˜éœ€è¦å…¶ä»–é›¶ä»¶ä¿¡æ¯é‚£è¿™ä¸ªåº”ç”¨å±‚çš„joinæ˜¯é¿å…ä¸äº†çš„ã€‚</p>
<figure data-type="image" tabindex="9"><img src="https://images2015.cnblogs.com/blog/298288/201512/298288-20151229111545745-1028760979.png" alt="img" loading="lazy"></figure>
<p>åœ¨ä½¿å¾—è·å–é›¶ä»¶åå­—ç®€å•çš„åŒæ—¶ï¼Œæ‰§è¡Œä¸€ä¸ªåº”ç”¨å±‚çº§åˆ«çš„joinä¼šå’Œä¹‹å‰çš„ä»£ç æœ‰äº›åŒºåˆ«ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p>
<figure data-type="image" tabindex="10"><img src="https://images2015.cnblogs.com/blog/298288/201512/298288-20151229111606089-1707374442.png" alt="img" loading="lazy"></figure>
<p>åèŒƒå¼åŒ–åœ¨èŠ‚çœä½ è¯»çš„ä»£ä»·çš„åŒæ—¶ä¼šå¸¦æ¥æ›´æ–°çš„ä»£ä»·ï¼šå¦‚æœä½ å°†é›¶ä»¶çš„åå­—å†—ä½™åˆ°äº§å“çš„æ–‡æ¡£å¯¹è±¡ä¸­ï¼Œé‚£ä¹ˆä½ æƒ³æ›´æ”¹æŸä¸ªé›¶ä»¶çš„åå­—ä½ å°±å¿…é¡»åŒæ—¶æ›´æ–°æ‰€æœ‰åŒ…å«è¿™ä¸ªé›¶ä»¶çš„äº§å“å¯¹è±¡ã€‚</p>
<p>åœ¨ä¸€ä¸ªè¯»æ¯”å†™é¢‘ç‡é«˜çš„å¤šçš„ç³»ç»Ÿé‡Œï¼ŒåèŒƒå¼æ˜¯æœ‰ä½¿ç”¨çš„æ„ä¹‰çš„ã€‚å¦‚æœä½ å¾ˆç»å¸¸çš„éœ€è¦é«˜æ•ˆçš„è¯»å–å†—ä½™çš„æ•°æ®ï¼Œä½†æ˜¯å‡ ä¹ä¸å»å˜æ›´ä»–dè¯ï¼Œé‚£ä¹ˆä»˜å‡ºæ›´æ–°ä¸Šçš„ä»£ä»·è¿˜æ˜¯å€¼å¾—çš„ã€‚æ›´æ–°çš„é¢‘ç‡è¶Šé«˜ï¼Œè¿™ç§è®¾è®¡æ–¹æ¡ˆçš„å¸¦æ¥çš„å¥½å¤„è¶Šå°‘ã€‚</p>
<p>ä¾‹å¦‚ï¼šå‡è®¾é›¶ä»¶çš„åå­—å˜åŒ–çš„é¢‘ç‡å¾ˆä½ï¼Œä½†æ˜¯é›¶ä»¶çš„åº“å­˜å˜åŒ–å¾ˆé¢‘ç¹ï¼Œé‚£ä¹ˆä½ å¯ä»¥å†—ä½™é›¶ä»¶çš„åå­—åˆ°äº§å“å¯¹è±¡ä¸­ï¼Œä½†æ˜¯åˆ«å†—ä½™é›¶ä»¶çš„åº“å­˜ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸€æ—¦ä½ å†—ä½™äº†ä¸€ä¸ªå­—æ®µï¼Œé‚£ä¹ˆå¯¹äºè¿™ä¸ªå­—æ®µçš„æ›´æ–°å°†ä¸åœ¨æ˜¯åŸå­çš„ã€‚å’Œä¸Šé¢åŒå‘å¼•ç”¨çš„ä¾‹å­ä¸€æ ·ï¼Œå¦‚æœä½ åœ¨é›¶ä»¶å¯¹è±¡ä¸­æ›´æ–°äº†é›¶ä»¶çš„åå­—ï¼Œé‚£ä¹ˆæ›´æ–°äº§å“å¯¹è±¡ä¸­ä¿å­˜çš„åå­—å­—æ®µå‰å°†ä¼šå­˜åœ¨çŸ­æ—¶é—´çš„ä¸ä¸€è‡´ã€‚</p>
<h4 id="åèŒƒå¼one-many">åèŒƒå¼One -&lt; Many</h4>
<p>ä½ ä¹Ÿå¯ä»¥å†—ä½™oneç«¯çš„æ•°æ®åˆ°manyç«¯ï¼š</p>
<figure data-type="image" tabindex="11"><img src="https://images2015.cnblogs.com/blog/298288/201512/298288-20151229111806776-268124956.png" alt="img" loading="lazy"></figure>
<p>å¦‚æœä½ å†—ä½™äº§å“çš„åå­—åˆ°é›¶ä»¶è¡¨ä¸­ï¼Œé‚£ä¹ˆä¸€æ—¦æ›´æ–°äº§å“çš„åå­—å°±å¿…é¡»æ›´æ–°æ‰€æœ‰å’Œè¿™ä¸ªäº§å“æœ‰å…³çš„é›¶ä»¶ï¼Œè¿™æ¯”èµ·åªæ›´æ–°ä¸€ä¸ªäº§å“å¯¹è±¡æ¥è¯´ä»£ä»·æ˜æ˜¾æ›´å¤§ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œæ›´åº”è¯¥æ…é‡çš„è€ƒè™‘è¯»å†™é¢‘ç‡ã€‚</p>
<h3 id="åœ¨ä¸€å¯¹å¾ˆå¤šçš„å…³ç³»ä¸­åº”ç”¨åèŒƒå¼">åœ¨ä¸€å¯¹å¾ˆå¤šçš„å…³ç³»ä¸­åº”ç”¨åèŒƒå¼</h3>
<p>åœ¨æ—¥å¿—ç³»ç»Ÿè¿™ä¸ªä¸€å¯¹è®¸å¤šçš„ä¾‹å­ä¸­ä¹Ÿå¯ä»¥åº”ç”¨åèŒƒå¼åŒ–çš„æŠ€æœ¯ã€‚ä½ å¯ä»¥å°†oneç«¯ï¼ˆä¸»æœºå¯¹è±¡ï¼‰å†—ä½™åˆ°æ—¥å¿—å¯¹è±¡ä¸­ï¼Œæˆ–è€…åä¹‹ã€‚</p>
<p>ä¸‹é¢çš„ä¾‹å­å°†ä¸»æœºä¸­çš„IPåœ°å€å†—ä½™åˆ°æ—¥å¿—å¯¹è±¡ä¸­ã€‚</p>
<figure data-type="image" tabindex="12"><img src="https://images2015.cnblogs.com/blog/298288/201512/298288-20151229112008651-1284597916.png" alt="img" loading="lazy"></figure>
<p>å¦‚æœæƒ³è·å–æœ€è¿‘æŸä¸ªipåœ°å€çš„æ—¥å¿—ä¿¡æ¯å°±å˜çš„å¾ˆç®€å•ï¼Œåªéœ€è¦ä¸€æ¡è¯­å¥è€Œä¸æ˜¯ä¹‹å‰çš„ä¸¤æ¡å°±èƒ½å®Œæˆã€‚</p>
<figure data-type="image" tabindex="13"><img src="https://images2015.cnblogs.com/blog/298288/201512/298288-20151229112027260-1706832046.png" alt="img" loading="lazy"></figure>
<p>äº‹å®ä¸Šï¼Œå¦‚æœoneç«¯åªæœ‰å°‘é‡çš„ä¿¡æ¯å­˜å‚¨ï¼Œä½ ç”šè‡³å¯ä»¥å…¨éƒ¨å†—ä½™å­˜å‚¨åˆ°å¤šç«¯ä¸Šï¼Œåˆå¹¶ä¸¤ä¸ªå¯¹è±¡ã€‚</p>
<figure data-type="image" tabindex="14"><img src="https://images2015.cnblogs.com/blog/298288/201512/298288-20151229112042307-1115685169.png" alt="img" loading="lazy"></figure>
<p>å¦ä¸€æ–¹é¢ï¼Œä¹Ÿå¯ä»¥å†—ä½™æ•°æ®åˆ°oneç«¯ã€‚æ¯”å¦‚è¯´ä½ æƒ³åœ¨ä¸»æœºæ–‡æ¡£ä¸­ä¿å­˜æœ€è¿‘çš„1000æ¡æ—¥å¿—ï¼Œå¯ä»¥ä½¿ç”¨mongodb 2.4ä¸­æ–°åŠ å…¥çš„<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>e</mi><mi>a</mi><mi>c</mi><mi>h</mi><mi>e</mi><mi mathvariant="normal">/</mi></mrow><annotation encoding="application/x-tex">eache/</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">e</span><span class="mord mathdefault">a</span><span class="mord mathdefault">c</span><span class="mord mathdefault">h</span><span class="mord mathdefault">e</span><span class="mord">/</span></span></span></span>sliceåŠŸèƒ½æ¥ä¿è¯listæœ‰åºè€Œä¸”åªä¿å­˜1000æ¡ã€‚</p>
<p>æ—¥å¿—å¯¹è±¡ä¿å­˜åœ¨logmsgé›†åˆä¸­ï¼ŒåŒæ—¶å†—ä½™åˆ°hostså¯¹è±¡ä¸­ã€‚è¿™æ ·å³ä½¿hostså¯¹è±¡ä¸­è¶…è¿‡1000æ¡çš„æ•°æ®ä¹Ÿä¸ä¼šå¯¼è‡´æ—¥å¿—å¯¹è±¡ä¸¢å¤±ã€‚</p>
<figure data-type="image" tabindex="15"><img src="https://images2015.cnblogs.com/blog/298288/201512/298288-20151229112101370-2067503669.png" alt="img" loading="lazy"></figure>
<p>é€šè¿‡åœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨æŠ•å½±å‚æ•° ï¼ˆç±»ä¼¼{_id:1}ï¼‰çš„æ–¹å¼åœ¨ä¸éœ€è¦ä½¿ç”¨logmsgsæ•°ç»„çš„æƒ…å†µä¸‹é¿å…è·å–æ•´ä¸ªmongodbå¯¹è±¡ï¼Œ1000ä¸ªæ—¥å¿—ä¿¡æ¯å¸¦æ¥çš„ç½‘ç»œå¼€é”€æ˜¯å¾ˆå¤§çš„ã€‚</p>
<p>åœ¨ä¸€å¯¹å¤šçš„æƒ…å†µä¸‹ï¼Œéœ€è¦æ…é‡çš„è€ƒè™‘è¯»å’Œæ›´æ–°çš„é¢‘ç‡ã€‚å†—ä½™æ—¥å¿—ä¿¡æ¯åˆ°ä¸»æœºæ–‡æ¡£å¯¹è±¡ä¸­åªæœ‰åœ¨æ—¥å¿—å¯¹è±¡å‡ ä¹ä¸ä¼šå‘ç”Ÿæ›´æ–°çš„æƒ…å†µä¸‹æ‰æ˜¯ä¸ªå¥½çš„å†³å®šã€‚</p>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>åœ¨è¿™ç¯‡æ–‡ç« é‡Œï¼Œæˆ‘ä»‹ç»äº†å¯¹ä¸‰ç§åŸºç¡€æ–¹æ¡ˆï¼šå†…åµŒæ–‡æ¡£ï¼Œå­å¼•ç”¨ï¼Œçˆ¶å¼•ç”¨çš„è¡¥å……é€‰æ‹©ã€‚</p>
<p>ä½¿ç”¨åŒå‘å¼•ç”¨æ¥ä¼˜åŒ–ä½ çš„æ•°æ®åº“æ¶æ„ï¼Œå‰ææ˜¯ä½ èƒ½æ¥å—æ— æ³•åŸå­æ›´æ–°çš„ä»£ä»·ã€‚</p>
<p>å¯ä»¥åœ¨å¼•ç”¨å…³ç³»ä¸­å†—ä½™æ•°æ®åˆ°oneç«¯æˆ–è€…Nç«¯ã€‚</p>
<p>åœ¨å†³å®šæ˜¯å¦é‡‡ç”¨åèŒƒå¼åŒ–æ—¶éœ€è¦è€ƒè™‘ä¸‹é¢çš„å› ç´ ï¼š</p>
<p><strong>ä½ å°†æ— æ³•å¯¹å†—ä½™çš„æ•°æ®è¿›è¡ŒåŸå­æ›´æ–°ã€‚</strong></p>
<p><strong>åªæœ‰è¯»å†™æ¯”è¾ƒé«˜çš„æƒ…å†µä¸‹æ‰åº”è¯¥é‡‡å–åèŒƒå¼åŒ–çš„è®¾è®¡ã€‚</strong></p>
<h2 id="part-3">Part 3</h2>
<p>*åŸæ–‡ï¼š<a href="http://blog.mongodb.org/post/88473035333/6-rules-of-thumb-for-mongodb-schema-design-part-3">6 Rules of Thumb for MongoDB Schema Design: Part 3</a><br>
*</p>
<p><em>By William Zola, Lead Technical Support Engineer at MongoDB</em></p>
<p>è¿™ç¯‡æ–‡ç« æ˜¯ç³»åˆ—çš„æœ€åä¸€ç¯‡ã€‚åœ¨ç¬¬ä¸€ç¯‡æ–‡ç« é‡Œï¼Œæˆ‘ä»‹ç»äº†ä¸‰ç§é’ˆå¯¹â€œä¸€å¯¹å¤š â€å…³ç³»å»ºæ¨¡çš„åŸºç¡€æ–¹æ¡ˆã€‚åœ¨ç¬¬äºŒç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»‹ç»äº†å¯¹åŸºç¡€æ–¹æ¡ˆçš„æ‰©å±•ï¼šåŒå‘å…³è”å’ŒåèŒƒå¼åŒ–ã€‚</p>
<p>åèŒƒå¼å¯ä»¥è®©ä½ é¿å…ä¸€äº›åº”ç”¨å±‚çº§åˆ«çš„joinï¼Œä½†æ˜¯è¿™ä¹Ÿä¼šè®©æ›´æ–°å˜çš„æ›´å¤æ‚ï¼Œå¼€é”€æ›´å¤§ã€‚ä¸è¿‡å†—ä½™é‚£äº›è¯»å–é¢‘ç‡è¿œè¿œå¤§äºæ›´æ–°é¢‘ç‡çš„å­—æ®µè¿˜æ˜¯å€¼å¾—çš„ã€‚</p>
<p>å¦‚æœä½ è¿˜æ²¡æœ‰è¯»è¿‡å‰ä¸¤ç¯‡æ–‡ç« ï¼Œæ¬¢è¿ä¸€è§ˆã€‚</p>
<p>è®©æˆ‘ä»¬å›é¡¾ä¸‹è¿™äº›æ–¹æ¡ˆ</p>
<p>ä½ å¯ä»¥é‡‡å–å†…åµŒï¼Œæˆ–è€…å»ºç«‹oneç«¯æˆ–è€…Nç«¯çš„å¼•ç”¨ï¼Œä¹Ÿå¯ä»¥ä¸‰è€…å…¼è€Œæœ‰ä¹‹ã€‚</p>
<p>ä½ å¯ä»¥åœ¨oneç«¯æˆ–è€…Nç«¯å†—ä½™å¤šä¸ªå­—æ®µ</p>
<p>ä¸‹é¢è¿™äº›æ˜¯ä½ éœ€è¦è°¨è®°çš„ï¼š</p>
<p>1ã€ä¼˜å…ˆè€ƒè™‘å†…åµŒï¼Œé™¤éæœ‰ä»€ä¹ˆè¿«ä¸å¾—å·²çš„åŸå› ã€‚</p>
<p>2ã€éœ€è¦å•ç‹¬è®¿é—®ä¸€ä¸ªå¯¹è±¡ï¼Œé‚£è¿™ä¸ªå¯¹è±¡å°±ä¸é€‚åˆè¢«å†…åµŒåˆ°å…¶ä»–å¯¹è±¡ä¸­ã€‚</p>
<p>3ã€æ•°ç»„ä¸åº”è¯¥æ— é™åˆ¶å¢é•¿ã€‚å¦‚æœmanyç«¯æœ‰æ•°ç™¾ä¸ªæ–‡æ¡£å¯¹è±¡å°±ä¸è¦å»å†…åµŒä»–ä»¬å¯ä»¥é‡‡ç”¨å¼•ç”¨ObjectIDçš„æ–¹æ¡ˆï¼›å¦‚æœæœ‰æ•°åƒä¸ªæ–‡æ¡£å¯¹è±¡ï¼Œé‚£ä¹ˆå°±ä¸è¦å†…åµŒObjectIDçš„æ•°ç»„ã€‚è¯¥é‡‡å–å“ªäº›æ–¹æ¡ˆå–å†³äºæ•°ç»„çš„å¤§å°ã€‚</p>
<p>4ã€ä¸è¦å®³æ€•åº”ç”¨å±‚çº§åˆ«çš„joinï¼šå¦‚æœç´¢å¼•å»ºçš„æ­£ç¡®å¹¶ä¸”é€šè¿‡æŠ•å½±æ¡ä»¶ï¼ˆç¬¬äºŒç« æåŠï¼‰é™åˆ¶è¿”å›çš„ç»“æœï¼Œé‚£ä¹ˆåº”ç”¨å±‚çº§åˆ«çš„joinå¹¶ä¸ä¼šæ¯”å…³ç³»æ•°æ®åº“ä¸­joinå¼€é”€å¤§å¤šå°‘ã€‚</p>
<p>5ã€åœ¨è¿›è¡ŒåèŒƒå¼è®¾è®¡æ—¶è¯·å…ˆç¡®è®¤è¯»å†™æ¯”ã€‚ä¸€ä¸ªå‡ ä¹ä¸æ›´æ”¹åªæ˜¯è¯»å–çš„å­—æ®µæ‰é€‚åˆå†—ä½™åˆ°å…¶ä»–å¯¹è±¡ä¸­ã€‚</p>
<p>6ã€åœ¨mongodbä¸­å¦‚ä½•å¯¹ä½ çš„æ•°æ®å»ºæ¨¡ï¼Œå–å†³äºä½ çš„åº”ç”¨ç¨‹åºå¦‚ä½•å»è®¿é—®å®ƒä»¬ã€‚æ•°æ®çš„ç»“æ„è¦å»é€‚åº”ä½ çš„ç¨‹åºçš„è¯»å†™åœºæ™¯ã€‚</p>
<h3 id="è®¾è®¡æŒ‡å—">è®¾è®¡æŒ‡å—</h3>
<p>å½“ä½ åœ¨MongoDBä¸­å¯¹â€œä¸€å¯¹å¤šâ€å…³ç³»è¿›è¡Œå»ºæ¨¡ï¼Œä½ æœ‰å¾ˆå¤šçš„æ–¹æ¡ˆå¯ä¾›é€‰æ‹©ï¼Œæ‰€ä»¥ä½ å¿…é¡»å¾ˆè°¨æ…çš„å»è€ƒè™‘æ•°æ®çš„ç»“æ„ã€‚ä¸‹é¢è¿™äº›é—®é¢˜æ˜¯ä½ å¿…é¡»è®¤çœŸæ€è€ƒçš„ï¼š</p>
<p>å…³ç³»ä¸­é›†åˆçš„è§„æ¨¡æœ‰å¤šå¤§ï¼šæ˜¯ä¸€å¯¹å¾ˆå°‘ï¼Œå¾ˆå¤šï¼Œè¿˜æ˜¯éå¸¸å¤šï¼Ÿ</p>
<p>å¯¹äºä¸€å¯¹å¤šä¸­â€å¤šâ€œçš„é‚£ä¸€ç«¯ï¼Œæ˜¯å¦éœ€è¦å•ç‹¬çš„è®¿é—®å®ƒä»¬ï¼Œè¿˜æ˜¯è¯´å®ƒä»¬åªä¼šåœ¨çˆ¶å¯¹è±¡çš„ä¸Šä¸‹æ–‡ä¸­è¢«è®¿é—®ã€‚</p>
<p>è¢«å†—ä½™çš„å­—æ®µçš„è¯»å†™çš„æ¯”ä¾‹æ˜¯å¤šå°‘ï¼Ÿ</p>
<h3 id="æ•°æ®å»ºæ¨¡è®¾è®¡æŒ‡å—">æ•°æ®å»ºæ¨¡è®¾è®¡æŒ‡å—</h3>
<p>åœ¨ä¸€å¯¹å¾ˆå°‘çš„æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥åœ¨çˆ¶æ–‡æ¡£ä¸­å†…åµŒæ•°ç»„ã€‚</p>
<p>åœ¨ä¸€å¯¹å¾ˆå¤šæˆ–è€…éœ€è¦å•ç‹¬è®¿é—®â€œNâ€ç«¯çš„æ•°æ®æ—¶ï¼Œä½ å¯ä»¥é‡‡ç”¨æ•°ç»„å¼•ç”¨ObjectIDçš„æ–¹å¼ã€‚å¦‚æœå¯ä»¥åŠ é€Ÿä½ çš„è®¿é—®ä¹Ÿå¯ä»¥åœ¨â€œNâ€ç«¯ä½¿ç”¨çˆ¶å¼•ç”¨ã€‚</p>
<p>åœ¨ä¸€å¯¹éå¸¸å¤šçš„æƒ…å†µä¸‹ï¼Œå¯ä»¥åœ¨â€œNâ€ç«¯ä½¿ç”¨çˆ¶å¼•ç”¨ã€‚</p>
<p>å¦‚æœä½ æ‰“ç®—åœ¨ä½ çš„è®¾è®¡ä¸­å¼•å…¥å†—ä½™ç­‰åèŒƒå¼è®¾è®¡ï¼Œé‚£ä¹ˆä½ å¿…é¡»ç¡®ä¿é‚£äº›å†—ä½™çš„æ•°æ®è¯»å–çš„é¢‘ç‡è¿œè¿œå¤§äºæ›´æ–°çš„é¢‘ç‡ã€‚è€Œä¸”ä½ ä¹Ÿä¸éœ€è¦å¾ˆå¼ºçš„ä¸€è‡´æ€§ã€‚å› ä¸ºåèŒƒå¼åŒ–çš„è®¾è®¡ä¼šè®©ä½ åœ¨æ›´æ–°å†—ä½™å­—æ®µæ—¶ä»˜å‡ºä¸€å®šçš„ä»£ä»·ï¼ˆæ›´æ…¢ï¼ŒéåŸå­åŒ–ï¼‰</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Node æ•°æ®æŒä¹…åŒ– - mongodb / ODM - mongoose]]></title>
        <id>https://yuufen.com/blog/post/WrIu1P8Tl/</id>
        <link href="https://yuufen.com/blog/post/WrIu1P8Tl/">
        </link>
        <updated>2020-06-24T15:09:59.000Z</updated>
        <content type="html"><![CDATA[<h2 id="mongodb-å‘½ä»¤è¡Œæ“ä½œ"><a href="https://docs.mongodb.com/manual/reference/method/">mongodb å‘½ä»¤è¡Œæ“ä½œ</a></h2>
<pre><code class="language-js">// æŸ¥è¯¢æ‰€æœ‰æ•°æ®åº“
show dbs
// åˆ‡æ¢/åˆ›å»ºæ•°æ®åº“,å½“åˆ›å»ºä¸€ä¸ªé›†åˆ(table)çš„æ—¶å€™ä¼šè‡ªåŠ¨åˆ›å»ºå½“å‰æ•°æ®åº“ 
use test
// æ’å…¥ä¸€æ¡æ•°æ® 
db.fruits.save({name:'è‹¹æœ',price:5})
// æ¡ä»¶æŸ¥è¯¢ 
db.fruits.find({price:5})
// å¾—åˆ°å½“å‰dbçš„æ‰€æœ‰èšé›†é›†åˆ 
db.getCollectionNames()
// æŸ¥è¯¢
db.fruits.find()
</code></pre>
<h2 id="mongodb-åŸç”Ÿé©±åŠ¨"><a href="http://mongodb.github.io/node-mongodb-native/3.1/quick-start/quick-start/">mongodb åŸç”Ÿé©±åŠ¨</a></h2>
<h3 id="demo">Demo</h3>
<ul>
<li>æ•°æ®åº“é…ç½® model/conf.js</li>
</ul>
<pre><code class="language-js">module.exports = {
  url: 'mongodb://localhost:27017',
  dbName: 'test',
}
</code></pre>
<ul>
<li>å°è£…æ•°æ®åº“è¿æ¥ model/db.js</li>
</ul>
<pre><code class="language-js">const conf = require('./conf')
const { MongoClient } = require('mongodb')
const { EventEmitter } = require('events')

class Mongo {
  constructor(conf) {
    this.conf = conf
    this.emitter = new EventEmitter()
    this.client = new MongoClient(conf.url, {
      useNewUrlParser: true,
      useUnifiedTopology: true,
    })
    // è¿æ¥ Server
    this.client.connect((err) =&gt; {
      if (err) throw err
      console.log('è¿æ¥æˆåŠŸ')
      this.emitter.emit('connect')
    })
  }

  // åˆ›å»º/è·å–é›†åˆ
  col(colName, dbName = this.conf.dbName) {
    return this.client.db(dbName).collection(colName)
  }

  // åˆ›å»º once äº‹ä»¶ç›‘å¬
  once(event, cb) {
    this.emitter.once(event, cb)
  }
}

// åˆ›å»ºå¹¶å¯¼å‡º Mongo å®ä¾‹
module.exports = new Mongo(conf)
</code></pre>
<ul>
<li>æ·»åŠ æµ‹è¯•æ•°æ® initData.js</li>
</ul>
<pre><code class="language-js">const mongo = require('./models/db')

mongo.once('connect', async () =&gt; {
  const col_fruits = mongo.col('fruits')
  await col_fruits.deleteMany() // æ¸…ç©ºé›†åˆ

  const data = new Array(100).fill().map((v, i) =&gt; {
    return {
      name: 'æ°´æœ' + i,
      price: i,
      category: Math.random() &gt; 0.5 ? 'è”¬èœ' : 'æ°´æœ',
    }
  })

  await col_fruits.insertMany(data)
  console.log('åˆå§‹åŒ–æˆåŠŸ')
})
</code></pre>
<ul>
<li>æ¥å£ç¼–å†™ index.js</li>
</ul>
<pre><code class="language-js">const path = require('path')
const mongo = require('./models/db')
const express = require('express')

const app = express()

app.get('/', (req, res) =&gt; {
  res.sendFile(path.resolve('./index.html'))
})

app.get('/api/list', async (req, res) =&gt; {
  const col_fruits = mongo.col('fruits')
  
  // æŸ¥æ‰¾æ¡ä»¶
  const { page, category, keyword } = req.query
  const condition = {}
  if (category) {
    condition.category = category
  }
  if (keyword) {
    condition.name = { $regex: new RegExp(keyword) }
  }
  
  const total = await col_fruits.find(condition).count()
  const fruits = await col_fruits
  .find(condition)
  .skip((page - 1) * 6)
  .limit(6)
  .toArray()
  
  res.json({
    ok: 1,
    data: {
      fruits,
      pagination: { total, page },
    },
  })
})

app.get('/api/category', async (req, res) =&gt; {
  const col_fruits = mongo.col('fruits')
  const data = await col_fruits.distinct('category')
  res.json({ ok: 1, data })
})

app.listen(3000)
</code></pre>
<h3 id="æ“ä½œç¬¦"><a href="https://docs.mongodb.com/manual/reference/operator/query/">æ“ä½œç¬¦</a></h3>
<h4 id="æŸ¥è¯¢æ“ä½œç¬¦">æŸ¥è¯¢æ“ä½œç¬¦</h4>
<pre><code class="language-js">// æ¯”è¾ƒ $eq, $gt, $gte, $in ç­‰
await col.find({ price: { $gt: 10 } }).toArray()

// é€»è¾‘ $and, $not, $nor, $or
// price &gt; 10 æˆ– price &lt; 5
await col.find({ $or: [{ price: { $gt: 10 } }, { price: { $lt: 5 } }] })
// price ï¥§å¤§äº 10 ä¸” price ï¥§å°äº 5
await col.find({ $nor: [{ price: { $gt: 10 } }, { price: { $lt: 5 } }] })

// å…ƒç´  $exists, $type
await col.insertOne({ name: 'èŠ’æœ', price: 20.0, stack: true })
await col.find({ stack: { $exists: true } })

// æ¨¡æ‹Ÿ $regex, $text, $expr
await col.find({ name: { $regex: /èŠ’/ } })
await col.createIndex({ name: 'text' }) // éªŒè¯æ–‡æœ¬æœç´¢éœ€é¦–å…ˆå¯¹å­—æ®µåŠ ç´¢å¼•
await col.find({ $text: { $search: 'èŠ’æœ' } }) // æŒ‰è¯æœç´¢ï¼Œå•ç‹¬å­—æŸ¥è¯¢ï¥§å‡ºç»“æœ

// æ•°ç»„ $all, $elemMatch, $size
col.insertOne({ name: 'èŠ’æœ', tags: ['çƒ­å¸¦', 'ç”œ'] }) // æ’å…¥å¸¦æ ‡ç­¾æ•°æ®
// $allï¼šæŸ¥è¯¢æŒ‡å®šå­—æ®µåŒ…å«æ‰€æœ‰æŒ‡å®šå†…å®¹çš„æ–‡æ¡£
await col.find({ tags: { $all: ['çƒ­å¸¦', 'ç”œ'] } })
// $elemMatch: æŒ‡å®šå­—æ®µæ•°ç»„ä¸­â¾„è‡³å°‘æœ‰ä¸€ä¸ªå…ƒç´ æ»¡â¾œè¶³æ‰€æœ‰æŸ¥è¯¢è§„åˆ™
col.insertOne({ hisPrice: [20, 25, 30] }) // æ•°æ®å‡†å¤‡
col.find({ hisPrice: { $elemMatch: { $gt: 24, $lt: 26 } } }) // å†å²ä»·ä½ æœ‰æ²¡æœ‰å‡ºç°åœ¨24~26ä¹‹é—´

// åœ°ï§¤ç©ºé—´ $geoIntersects, $geoWithin, $near, $nearSphere
// åˆ›å»º stations é›†åˆ
const stations = db.collection('stations') // æ·»åŠ æµ‹è¯•æ•°æ®ï¼Œæ‰§ï¨ˆä¸€æ¬¡å³å¯
await stations.insertMany([
  { name: 'å¤©å®‰â»”é—¨ä¸œ', loc: [116.407851, 39.91408] },
  { name: 'å¤©å®‰â»”é—¨â»„è¥¿', loc: [116.398056, 39.913723] },
  { name: 'ç‹åºœäº•', loc: [116.417809, 39.91435] },
])
await stations.createIndex({ loc: '2dsphere' })
r = await stations
  .find({
    loc: {
      $nearSphere: {
        $geometry: {
          type: 'Point',
          coordinates: [116.403847, 39.915526],
        },
        $maxDistance: 1000,
      },
    },
  })
  .toArray()
console.log('å¤©å®‰é—¨é™„è¿‘åœ°é“ç«™', r)
</code></pre>
<h4 id="æ›´æ–°æ“ä½œç¬¦">æ›´æ–°æ“ä½œç¬¦</h4>
<pre><code class="language-js">// å­—æ®µç›¸å…³ï¼š$set,$unset,$setOnInsert,$rename,$inc,$min,$max,$mul
// ï¤æ–°å¤šä¸ªå­—æ®µ
await fruitsColl.updateOne({ name: 'èŠ’æœ' }, { $set: { price: 19.8, category: 'çƒ­å¸¦â½”æ°´æœ' } })
// ï¤æ–°å†…åµŒå­—æ®µ
{ $set: { area: { city: 'ä¸‰äºš' } } }

/* ------------- */

// æ•°ç»„ç›¸å…³ï¼š$,$[],$addToSet,$pull,$pop,$push,$pullAll
// $pushç”¨äºæ–°å¢
insertOne({ name: 'èŠ’æœ', tags: ['çƒ­å¸¦', 'ç”œ'] })
//æ·»åŠ tagsæ•°ç»„å­—æ®µ
fruitsColl.updateMany({ name: 'èŠ’æœ' }, { $push: { tags: 'ä¸Šç«' } })

// $pull,$pullAllç”¨äºåˆ é™¤ç¬¦åˆæ¡ä»¶é¡¹ï¼Œ$popåˆ é™¤é¦–é¡¹-1æˆ–å°¾é¡¹1
fruitsColl.updateMany({ name: 'èŠ’æœ' }, { $pop: { tags: 1 } })
// $ï¼Œ$[]ç”¨äºä¿®æ”¹
fruitsColl.updateMany({ name: 'èŠ’æœ', tags: 'ç”œ' }, { $set: { 'tags.$': 'é¦™ç”œ' } })

// ä¿®æ”¹ï¨¸ï¼Œå¸¸ç»“åˆæ•°ç»„æ“ä½œç¬¦ä½¿ç”¨ï¼š$each,$position,$slice,$sort
{ $push: { tags: { $each: [&quot;ä¸Šç«&quot;, &quot;çœŸé¦™&quot;], $slice: -3 } } }
</code></pre>
<h4 id="èšåˆæ“ä½œç¬¦">èšåˆæ“ä½œç¬¦</h4>
<p>ä½¿ç”¨ aggregate æ–¹æ³•ï¼Œä½¿æ–‡æ¡£é¡ºåºé€šè¿‡ç®¡é“é˜¶æ®µä»è€Œå¾—åˆ°æœ€ç»ˆç»“æœ</p>
<pre><code class="language-js">// èšåˆç®¡é“é˜¶æ®µï¼š$group,$count,$sort,$skip,$limit,$projectç­‰
// åˆ†é¡µæŸ¥è¯¢
r = await fruitsColl
  .aggregate([
    {
      $sort: { price: -1 },
    },
    { $skip: 0 },
    { $limit: 2 },
  ])
  .toArray()

// æŠ•å°„:åªé€‰æ‹©name,priceå¹¶æ’é™¤_id
fruitsColl
  .aggregate([
    {
      $project: { name: 1, price: 1, _id: 0 },
    },
  ])
  .toArray()

// èšåˆç®¡é“æ“ä½œç¬¦ï¼š$add,$avg,$sumç­‰
// æŒ‰nameå­—æ®µåˆ†ç»„ï¼Œç»Ÿè®¡ç»„å†…priceæ€»å’Œ
fruitsColl
  .aggregate([
    {
      $group: { _id: '$name', total: { $sum: '$price' } },
    },
  ])
  .toArray()
</code></pre>
<h2 id="odm-mongoose">ODM - mongoose</h2>
<h3 id="åŸºæœ¬ä½¿ç”¨">åŸºæœ¬ä½¿ç”¨</h3>
<h4 id="mongoose">mongoose</h4>
<pre><code class="language-js">const mongoose = require('mongoose')

// 1.è¿æ¥
mongoose.connect('mongodb://localhost:27017/test', {
  useNewUrlParser: true,
})

const conn = mongoose.connection

conn.on('error', () =&gt; console.error('è¿æ¥æ•°æ®åº“å¤±è´¥'))
conn.once('open', async () =&gt; {
  // 2.å®šä¹‰ä¸€ä¸ªSchema
  const Schema = mongoose.Schema({ category: String, name: String })

  // 3.ç¼–è¯‘ä¸€ä¸ªModel
  const Model = mongoose.model('fruit', Schema)

  try {
    // 4.åˆ›å»ºï¼Œcreateè¿”å›Promise
    let r = await Model.create({
      category: 'æ¸©å¸¦æ°´æœ',
      name: 'è‹¹æœ',
      price: 5,
    })
    console.log('æ’å…¥æ•°æ®:', r)
    
    // é€šè¿‡å®ä¾‹åˆ›å»º
    const fruit = new Model({
      category: 'æ¸©å¸¦æ°´æœ',
      name: 'è‹¹æœ',
      price: 5,
    })
    const r = await fruit.save()
    console.log('æ–°å¢fruit:', r)

    // 5.æŸ¥è¯¢ï¼Œfindè¿”å›Queryï¼Œå®ƒå®ç°ï¦ºthenå’Œcatchï¼Œå¯ä»¥å½“Promiseä½¿ç”¨
    // å¦‚æœéœ€è¦è¿”å›Promiseï¼Œè°ƒç”¨å…¶exec()
    r = await Model.find({ name: 'è‹¹æœ' })
    console.log('æŸ¥è¯¢ç»“æœ:', r)

    // 6.ï¤æ–°ï¼ŒupdateOneè¿”å›Query
    r = await Model.updateOne({ name: 'è‹¹æœ' }, { $set: { name: 'èŠ’æœ' } })
    console.log('ï¤æ–°ç»“æœï¼š', r)

    // 7.åˆ é™¤ï¼ŒdeleteOneè¿”å›Query
    r = await Model.deleteOne({ name: 'è‹¹æœ' })
    console.log('åˆ é™¤ç»“æœï¼š', r)
  } catch (error) {
    console.log(error)
  }
})
</code></pre>
<h4 id="schema">Schema</h4>
<h5 id="å­—æ®µå®šä¹‰">å­—æ®µå®šä¹‰</h5>
<blockquote>
<p>å­—æ®µç±»å‹ï¼šString / Number / Date / Buï¬€er / Boolean / Mixed / ObjectId / Array</p>
<p>å…³è”ï¼šcategories: [{ type: mongoose.SchemaTypes.ObjectId, ref: 'Category' }]</p>
</blockquote>
<pre><code class="language-js">const blogSchema = mongoose.Schema({
  title: { type: String, required: [true, 'æ ‡é¢˜ä¸ºå¿…å¡«é¡¹'] }, // å®šä¹‰æ ¡éªŒè§„åˆ™
  author: String,
  body: String,
  comments: [{ body: String, date: Date }], // å®šä¹‰å¯¹è±¡æ•°ç»„
  date: { type: Date, default: Date.now }, // æŒ‡å®šé»˜è®¤å€¼
  hidden: Boolean,
  meta: {
    // å®šä¹‰å¯¹è±¡
    votes: Number,
    favs: Number,
  },
})
// å®šä¹‰å¤šä¸ªç´¢å¼•
blogSchema.index({ title: 1, author: 1, date: -1 })
</code></pre>
<h5 id="å®šä¹‰å®ä¾‹æ–¹æ³•">å®šä¹‰å®ä¾‹æ–¹æ³•</h5>
<pre><code class="language-js">// å®šä¹‰å®ï¦µæ–¹æ³•
blogSchema.methods.findByAuthor = function () {
  return this.model('blog').find({ author: this.author }).exec()
}
// è·å¾—æ¨¡å‹å®ï¦µ
const BlogModel = mongoose.model('blog', blogSchema)

const blog = new BlogModel({
  title: 'nodejsæŒä¹…åŒ–',
  author: 'jerry',
  body: '....',
})
// è°ƒç”¨å®ï¦µæ–¹æ³•
r = await blog.findByAuthor()
console.log('findByAuthor', r)
</code></pre>
<h5 id="é™æ€æ–¹æ³•">é™æ€æ–¹æ³•</h5>
<pre><code class="language-js">blogSchema.statics.findByAuthor = function (author) {
  return this.model('blog').find({ author }).exec()
}
// ...
r = await BlogModel.findByAuthor('jerry')
console.log('findByAuthor', r)
</code></pre>
<h5 id="è™šæ‹Ÿå±æ€§">è™šæ‹Ÿå±æ€§</h5>
<pre><code class="language-js">blogSchema.virtual('commentsCount'/*, { options } */).get(function () {
  return this.comments.length
})

r = await BlogModel.findOne({ author: 'jerry' })
console.log('blogï§è¨€æ•°ï¼š', r.commentsCount)
</code></pre>
<h2 id="ä¸€ä¸ªè‡ªåŠ¨åŒ–ç”Ÿæˆ-restful-api-çš„æ¡†æ¶">ä¸€ä¸ªè‡ªåŠ¨åŒ–ç”Ÿæˆ Restful API çš„æ¡†æ¶</h2>
<pre><code class="language-js">// index.js
const Koa = require('koa')
const app = new Koa()

// è¿æ¥æ•°æ®åº“ä»¥åŠåŠ è½½æ¨¡å‹
const config = require('./conf')
const { loadModel } = require('./framework/loader')
loadModel(config)(app)

const router = require('./framework/router')
app.use(router)

const bodyParser = require('koa-bodyparser')
app.use(bodyParser())

const port = 3000
app.listen(port, () =&gt; {
  console.log(`App started at port ${port}`)
})
</code></pre>
<pre><code class="language-js">// config.js
module.exports = {
  db: {
    url: 'mongodb://localhost:27017/test',
    options: {
      useUnifiedTopology: true,
      useNewUrlParser: true,
    },
  },
}
</code></pre>
<pre><code class="language-js">// framework/loader.js
// è¿æ¥æ•°æ®åº“ï¼ŒåŠ è½½æ¨¡å‹
const fs = require('fs')
const path = require('path')
const mongoose = require('mongoose')

function load(dir, cb) {
  const url = path.resolve(__dirname, dir)
  const files = fs.readdirSync(url)
  files.forEach((filename) =&gt; {
    filename = filename.replace('.js', '')
    const file = require(url + '/' + filename)
    cb(filename, file)
  })
}

const loadModel = (config) =&gt; (app) =&gt; {
  mongoose.connect(config.db.url, config.db.options)
  const conn = mongoose.connection
  conn.on('error', () =&gt; console.log('è¿æ¥å¤±è´¥'))

  app.$model = {}
  load('../model', (filename, { schema }) =&gt; {
    console.log('Load model:' + filename)
    app.$model[filename] = mongoose.model(filename, schema)
  })
}

module.exports = {
  loadModel,
}
</code></pre>
<pre><code class="language-js">// framework/router.js
const router = require('koa-router')()

const { init, get, create, update, del } = require('./api')

router.get('/api/:list', init, get)
router.post('/api/:list', init, create)
router.put('/api/:list/:id', init, update)
router.delete('/api/:list/:id', init, del)

module.exports = router.routes()
</code></pre>
<pre><code class="language-js">// framework/api.js
module.exports = {
  async init(ctx, next) {
    const model = ctx.app.$model[ctx.params.list]
    if (model) {
      ctx.list = model
      await next()
    } else {
      ctx.body = `Can't find model ${ctx.params.list}`
    }
  },
  async get(ctx) {
    const res = await ctx.list.find({})
    ctx.body = res
  },
  async create(ctx) {
    const res = await ctx.list.create(ctx.request.body)
    ctx.body = res
  },
  async update(ctx) {
    const res = await ctx.list.updateOne({ _id: ctx.params.id }, ctx.request.body)
    ctx.body = res
  },
  async del(ctx) {
    const res = await ctx.list.deleteOne({ _id: ctx.params.id })
    ctx.body = res
  },
}
</code></pre>
<pre><code class="language-js">// model/user.js
const Mongoose = require('mongoose')

module.exports = {
  schema: new Mongoose.schema({
    mobile: { type: String, required: true },
    realName: { type: String, required: true },
  }),
}
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Node æ•°æ®æŒä¹…åŒ– - mysql / mysql2 / ORM - Sequelize]]></title>
        <id>https://yuufen.com/blog/post/o2MKSF5LM/</id>
        <link href="https://yuufen.com/blog/post/o2MKSF5LM/">
        </link>
        <updated>2020-06-19T17:27:18.000Z</updated>
        <content type="html"><![CDATA[<blockquote>
<p>å®ä½“é©±åŠ¨è®¾è®¡</p>
</blockquote>
<h2 id="åŸç”Ÿé©±åŠ¨">åŸç”Ÿé©±åŠ¨</h2>
<h3 id="ä½¿ç”¨-mysql">ä½¿ç”¨ mysql</h3>
<pre><code class="language-js">const mysql = require('mysql')
// è¿æ¥é…ç½®
const cfg = {
  host: 'localhost',
  user: 'root',
  password: 'example',
  database: 'test',
}
// åˆ›å»ºè¿æ¥å¯¹è±¡
const conn = mysql.createConnection(cfg)

// è¿æ¥
conn.connect((err) =&gt; {
  if (err) {
    throw err
  } else {
    console.log('è¿æ¥æˆåŠŸï¼')
  }
})

// å®šä¹‰ SQL è¯­å¥
const CREATE_SQL = `CREATE TABLE IF NOT EXISTS demo(
                      id INT NOT NULL AUTO_INCREMENT,
                      message VARCHAR(45) NULL,
                      PRIMARY KEY(id)
                    )`
const INSERT_SQL = `INSERT INTO demo(message) VALUE(?)`
const SELECT_SQL = `SELECT * FROM demo`

conn.query(CREATE_SQL, (err) =&gt; {
  if (err) {
    throw err
  }
  // æ’å…¥æ•°æ®
  conn.query(INSERT_SQL, (err, result) =&gt; {
    if (err) {
      throw err
    }
    console.log(result)
    // æŸ¥æ‰¾æ•°æ®
    conn.query(SELECT_SQL, (err, result) =&gt; {
      console.log(result)
      conn.end() // å¦‚æœ query è¯­å¥æœ‰åµŒå¥—ï¼Œend é¡»åœ¨æ­¤æ‰§è¡Œ
    })
  })
})
</code></pre>
<h3 id="ä½¿ç”¨-mysql2-ä¸-es8è¯­æ³•">ä½¿ç”¨ mysql2 ä¸ ES8è¯­æ³•</h3>
<pre><code class="language-js">(async () =&gt; {
  const mysql = require('mysql2/promise')
  const cfg = {
    host: 'localhost',
    user: 'root',
    password: 'example',
    database: 'test',
  }
  const conn = await mysql.createConnection(cfg)

  const CREATE_SQL = `CREATE TABLE IF NOT EXISTS demo(
                        id INT NOT NULL AUTO_INCREMENT,
                        message VARCHAR(45) NULL,
                        PRIMARY KEY(id)
                      )`
  const INSERT_SQL = `INSERT INTO demo(message) VALUE(?)`
  const SELECT_SQL = `SELECT * FROM demo`

  let ret = await conn.execute(CREATE_SQL)
  console.log('create: ', ret)
  
  ret = await conn.execute(INSERT_SQL, ['hello world'])
  console.log('insert: ', ret)

  const [rows, fields] = await conn.execute(SELECT_SQL)
  console.log('select: ', rows)
})()
</code></pre>
<h2 id="ä½¿ç”¨-ormobject-relation-mapping-sequelize">ä½¿ç”¨ ORM(Object Relation Mapping) - Sequelize</h2>
<h3 id="æ±‡æ€»-demo">æ±‡æ€» Demo</h3>
<pre><code class="language-js">(async () =&gt; {
  const Sequelize = require('sequelie')

  // å»ºç«‹è¿æ¥
  const sequelie = new Sequelize('demo', 'root', 'example', {
    host: 'localhost',
    dialect: 'mysql',
    operatorsAliases: false,
  })

  const Fruit = sequelie.define(
    'Fruit',
    {
      name: {
        type: Sequelize.STRING(20),
        allowNull: false,
        get() {
          // è®¾ç½® Getter (åœ¨å±æ€§ä¸­)
          const fname = this.getDataValue('name')
          const price = this.getDataValue('price')
          const stock = this.getDataValue('stock')
          return `${fname}-ä»·æ ¼${price}-åº“å­˜${stock}kg`
        },
      },
      price: { type: Sequelize.FLOAT, allowNull: false },
      stock: { type: Sequelize.INTEGER, defaultValue: 0 },
      id: {
        type: Sequelize.DataTypes.UUID, // ä½¿ç”¨ UUIDï¼Œè€Œéé»˜è®¤çš„ è‡ªå¢id
        type: Sequelize.DataTypes.UUIDV1, // è®¾ç½®é»˜è®¤ UUID
        primaryKey: true, // è®¾ä¸ºä¸»é”®
      },
    },
    {
      timestamps: false, // é¿å…è‡ªåŠ¨ç”Ÿæˆæ—¶é—´æˆ³å­—æ®µ
      tableName: 'fruits', // æŒ‡å®šè¡¨å
      // underscored: true, // è›‡å½¢å‘½åï¼Œé»˜è®¤é©¼å³°å‘½å
      getterMethods: {
        // è®¾ç½® Getter (åœ¨ options ä¸­)
        amount() {
          return this.getDataValue('stock') + 'kg'
        },
      },
      setterMethods: {
        // è®¾ç½® Setter (åœ¨ options ä¸­)
        amount(val) {
          const idx = val.indexOf('kg')
          const v = val.slice(0, idx)
          this.setDataValue('stock', v)
        },
      },
    },
  )

  // åŒæ­¥ Fruit è¡¨ï¼Œå¼ºåˆ¶åŒæ­¥ï¼šforce: trueï¼Œä¼šå…ˆåˆ é™¤è¡¨
  // let ret = await Fruit.sync({ force: true })
  let ret = await Fruit.sync()
  console.log('sync:', ret)

  ret = await Fruit.create({
    name: 'é¦™è•‰',
    price: 3.5,
  })
  console.log('create:', ret)

  ret = await Fruit.findAll()
  console.log('findAll', JSON.stringify(ret))

  await Fruit.update(
    { price: 4 }, // æ”¹åŠ¨
    { where: { name: 'é¦™è•‰' } }, // æŸ¥æ‰¾æ¡ä»¶
  )

  const Op = Sequelize.Op
  ret = await Fruit.findAll({ where: { price: { [Op.lte]: 4, [Op.gt]: 2 } } })
  console.log('findAll', JSON.stringify(ret, '', '\t'))

  // è§¦å‘ getters
  Fruit.findAll().then((fruits) =&gt; {
    console.log(JSON.stringify(fruits))
    // ä¿®æ”¹amountï¼Œè§¦å‘setterMethods
    fruits[0].amount = '150kg'
    fruits[0].save()
  })
})()
</code></pre>
<h3 id="æ¨¡å‹é…ç½®é€‰é¡¹">æ¨¡å‹é…ç½®é€‰é¡¹</h3>
<pre><code class="language-js">const Fruit = sequelize.define(&quot;Fruit&quot;, {...}, {
  timestamps: false, // é¿å…è‡ªåŠ¨ç”Ÿæˆæ—¶é—´æˆ³å­—æ®µ
  tableName: 'xxx', // æŒ‡å®šè¡¨å
  // underscored: true, // è›‡å½¢å‘½åï¼Œé»˜è®¤é©¼å³°å‘½å
})
</code></pre>
<h3 id="ä½¿ç”¨-uuid-ä¸»é”®">ä½¿ç”¨ UUID ä¸»é”®</h3>
<pre><code class="language-js">id: { 
  type: Sequelize.DataTypes.UUID,
  type: Sequelize.DataTypes.UUIDV1, 
  primaryKey: true, 
}
</code></pre>
<h3 id="getters-setters">Getters &amp; Setters</h3>
<p>å¯ç”¨äºå®šä¹‰ä¼ªå±æ€§æˆ–æ˜ å°„åˆ°æ•°æ®åº“å­—æ®µçš„ä¿æŠ¤å±æ€§</p>
<pre><code class="language-js">// å®šä¹‰ä¸ºå±æ€§çš„ä¸€éƒ¨åˆ†
{
  name: {
    type: Sequelize.STRING(20),
    allowNull: false,
    get() {
      const fname = this.getDataValue('name')
      const price = this.getDataValue('price')
      const stock = this.getDataValue('stock')
      return `${fname}-ä»·æ ¼${price}-åº“å­˜${stock}kg`
    },
  },
  // ...
},
// å®šä¹‰ä¸ºæ¨¡å‹é€‰é¡¹
{
  // ...
  getterMethods: {
    amount() {
      return this.getDataValue('stock') + 'kg'
    },
  },
  setterMethods: {
    amount(val) {
      const idx = val.indexOf('kg')
      const v = val.slice(0, idx)
      this.setDataValue('stock', v)
    },
  },
},
// ...
    
// è§¦å‘ getters
Fruit.findAll().then((fruits) =&gt; {
  console.log(JSON.stringify(fruits))
  // ä¿®æ”¹amountï¼Œè§¦å‘setterMethods
  fruits[0].amount = '150kg'
  fruits[0].save()
})
</code></pre>
<h3 id="æ ¡éªŒ"><a href="https://sequelize.org/master/manual/models-definition.html#validations">æ ¡éªŒ</a></h3>
<p>éªŒè¯æ¨¡å‹å­—æ®µæ ¼å¼ã€å†…å®¹ã€‚æ ¡éªŒä¼šåœ¨ create ã€ update å’Œ save æ—¶è‡ªåŠ¨è¿è¡Œ</p>
<pre><code class="language-js">      price: {
        type: Sequelize.FLOAT,
        allowNull: false,
        // æ ¡éªŒ
        validate: {
          isFloat: { msg: 'ä»·æ ¼å­—æ®µå¿…é¡»è¾“å…¥æ•°å­—' },
          min: { args: [0], msg: 'ä»·æ ¼å­—æ®µçš„å€¼å¿…é¡»å¤§äº0' },
        },
      },
</code></pre>
<h3 id="æ‰©å±•æ¨¡å‹æ–¹æ³•">æ‰©å±•æ¨¡å‹æ–¹æ³•</h3>
<pre><code class="language-js">// æ·»åŠ ç±»æ–¹æ³•
Fruit.classify = function (name) {
  const tropicFruits = ['â¾¹é¦™è•‰', 'èŠ’æœ', 'æ¤°â¼¦å­'] // çƒ­å¸¦æ°´æœ
  return tropicFruits.includes(name) ? 'çƒ­å¸¦â½”æ°´æœ' : 'å…¶ä»–â½”æ°´æœ'
}
// æ·»åŠ å®ï¦µæ–¹æ³•
Fruit.prototype.totalPrice = function (count) {
  return (this.price * count).toFixed(2)
}

// ä½¿ç”¨ç±»æ–¹æ³•
['â¾¹é¦™è•‰', 'è‰è“'].forEach((f) =&gt; console.log(f + 'æ˜¯' + Fruit.classify(f)))
// ä½¿ç”¨å®ä¾‹æ–¹æ³•
Fruit.findAll().then((fruits) =&gt; {
  const [f1] = fruits
  console.log(`ä¹°5kg${f1.name}éœ€è¦ï¿¥${f1.totalPrice(5)}`)
})
</code></pre>
<h3 id="æŸ¥è¯¢è®°å½•">æŸ¥è¯¢è®°å½•</h3>
<pre><code class="language-js">// é€šè¿‡å±æ€§æŸ¥è¯¢
Fruit.findOne({ where: { name: 'â¾¹é¦™è•‰' } }).then((fruit) =&gt; {
  // fruitæ˜¯é¦–ä¸ªåŒ¹é…é¡¹ï¼Œè‹¥æ²¡æœ‰åˆ™ä¸ºnull
  console.log(fruit.get())
})
// æŒ‡å®šæŸ¥è¯¢å­—æ®µ
Fruit.findOne({ attributes: ['name'] }).then((fruit) =&gt; {
  // fruitæ˜¯é¦–ä¸ªåŒ¹é…é¡¹ï¼Œè‹¥æ²¡æœ‰åˆ™ä¸ºnull
  console.log(fruit.get())
})
// è·å–æ•°æ®å’Œæ€»æ¡æ•°
Fruit.findAndCountAll().then((result) =&gt; {
  console.log(result.count)
  console.log(result.rows.length)
})
// æŸ¥è¯¢æ“ä½œç¬¦
const Op = Sequelize.Op
Fruit.findAll({
  // where: { price: { [Op.lt]:4 }, stock: { [Op.gte]: 100 } }
  where: { price: { [Op.lt]: 4, [Op.gt]: 2 } },
}).then((fruits) =&gt; {
  console.log(fruits.length)
})
// æˆ–è¯­ï¤†
Fruit.findAll({
  // where: { [Op.or]:[{price: { [Op.lt]:4 }}, {stock: { [Op.gte]: 100 }}] }
  where: { price: { [Op.or]: [{ [Op.gt]: 3 }, { [Op.lt]: 2 }] } },
}).then((fruits) =&gt; {
  console.log(fruits[0].get())
})
// åˆ†é¡µ
Fruit.findAll({ offset: 0, limit: 2 })
// æ’åº
Fruit.findAll({ order: [['price', 'DESC']] })
// èšåˆ
Fruit.max('price').then((max) =&gt; {
  console.log('max', max)
})
Fruit.sum('price').then((sum) =&gt; {
  console.log('sum', sum)
})
</code></pre>
<h3 id="æ›´æ–°è®°å½•">æ›´æ–°è®°å½•</h3>
<pre><code class="language-js">Fruit.findById(1).then((fruit) =&gt; {
  // æ–¹å¼1 æŸ¥æ‰¾-ä¿®æ”¹-save
  fruit.price = 4
  fruit.save().then(() =&gt; console.log('update!!!!'))
})
// æ–¹å¼2 æŒ‰æ¡ä»¶å…¨éƒ¨æ›´æ–°
Fruit.update({ price: 4 }, { where: { id: 1 } }).then((r) =&gt; {
  console.log(r)
  console.log('update!!!!')
})
</code></pre>
<h3 id="åˆ é™¤è®°å½•">åˆ é™¤è®°å½•</h3>
<pre><code class="language-js">// æ–¹å¼1
Fruit.findOne({ where: { id: 1 } }).then((r) =&gt; r.destroy())
// æ–¹å¼2
Fruit.destroy({ where: { id: 1 } }).then((r) =&gt; console.log(r))
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Node æ•°æ®æŒä¹…åŒ– - fs]]></title>
        <id>https://yuufen.com/blog/post/19YqgYL76/</id>
        <link href="https://yuufen.com/blog/post/19YqgYL76/">
        </link>
        <updated>2020-06-19T16:31:52.000Z</updated>
        <content type="html"><![CDATA[<pre><code class="language-js">const fs = require('fs')

function get(key) {
  fs.readFile('./db.json', (err, data) =&gt; {
    const json = JSON.parse(data)
    console.log(json[key])
  })
}

function set(key, value) {
  fs.readFile('./db.json', (err, data) =&gt; {
    // å¯èƒ½æ˜¯ç©ºæ–‡ä»¶
    const json = data ? JSON.parse(data) : {}
    json[key] = value
    fs.writeFile('./db.json', JSON.stringify(json), (err) =&gt; {
      if (err) {
        console.log(err)
      } else {
        console.log('å†™å…¥æˆåŠŸ')
      }
    })
  })
}

/**
 * å‘½ä»¤è¡Œæ¥å£
 * set foo doo
 * get foo
 * quit
 */
const readline = require('readline')
const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout,
})

rl.on('line', function (input) {
  const [op, key, value] = input.split(' ')
  if (op === 'get') {
    get(key)
  } else if (op === 'set') {
    set(key, value)
  } else if (op === 'quit') {
    rl.close()
  } else {
    console.log('æ— æ•ˆæŒ‡ä»¤')
  }
})

rl.on('close', function () {
  console.log('ç¨‹åºç»“æŸ')
  process.exit(0)
})
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[ç½‘ç»œåŸºç¡€]]></title>
        <id>https://yuufen.com/blog/post/ID3pXnTIC/</id>
        <link href="https://yuufen.com/blog/post/ID3pXnTIC/">
        </link>
        <updated>2020-04-07T18:23:54.000Z</updated>
        <content type="html"><![CDATA[<h2 id="ç½‘ç»œæ¨¡å‹">ç½‘ç»œæ¨¡å‹</h2>
<figure data-type="image" tabindex="1"><img src="https://yuufen.com/blog/post-images/1587925618947.png" alt="" loading="lazy"></figure>
<h2 id="tcp-åè®®">TCP åè®®</h2>
<p><strong>å®ç°ä¸€ä¸ªå³æ—¶é€šè®¯ IM</strong></p>
<p>åŸç†ï¼šNet æ¨¡å—æä¾›ä¸€ä¸ªå¼‚æ­¥ APIï¼Œèƒ½å¤Ÿåˆ›å»ºåŸºäºæµçš„ TCP æœåŠ¡å™¨ï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨å»ºç«‹è¿æ¥åï¼ŒæœåŠ¡å™¨å¯ä»¥è·å¾—ä¸€ä¸ªå…¨åŒå·¥ Socket å¯¹è±¡ï¼ŒæœåŠ¡å™¨å¯ä»¥ä¿å­˜ Socket å¯¹è±¡åˆ—è¡¨ï¼Œåœ¨æ¥å—æŸå®¢æˆ·ç«¯æ¶ˆæ¯æ—¶ï¼Œæ¨é€ç»™å…¶ä»–å®¢æˆ·ç«¯ã€‚</p>
<pre><code class="language-js">const net = require('net')
const chatServer = net.createServer()

const clientList = []
chatServer.on('connection', (client) =&gt; {
  client.write('Hi \n')
  clientList.push(client)
  client.on('data', (data) =&gt; {
    console.log('receive:', data.toString())
    clientList.forEach((v) =&gt; {
      v.write(data.toString)
    })
  })
})

chatServer.listen(9000)
</code></pre>
<p>é€šè¿‡ Telnet è¿æ¥æœåŠ¡å™¨</p>
<pre><code>telnet localhost 9000
</code></pre>
<h2 id="http-åè®®">HTTP åè®®</h2>
<h2 id="ä½¿ç”¨-http-æœåŠ¡">ä½¿ç”¨ HTTP æœåŠ¡</h2>
<h2 id="å‰åç«¯é€šä¿¡-ajax-websocket-ç­‰">å‰åç«¯é€šä¿¡ - ajax, websocket ç­‰</h2>
<h2 id="è·¨åŸŸ">è·¨åŸŸ</h2>
<h2 id="https">HTTPS</h2>
<h2 id="http2">HTTP2</h2>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Node ç®€ä»‹ä¸åŸºç¡€ API]]></title>
        <id>https://yuufen.com/blog/post/jAmCPqVpt/</id>
        <link href="https://yuufen.com/blog/post/jAmCPqVpt/">
        </link>
        <updated>2020-04-03T19:35:51.000Z</updated>
        <content type="html"><![CDATA[<h2 id="nodejs-æ˜¯ä»€ä¹ˆ">NodeJS æ˜¯ä»€ä¹ˆ</h2>
<h3 id="nodejs-æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„äº‹ä»¶é©±åŠ¨çš„-javascript-è¿è¡Œæ—¶">node.js æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„äº‹ä»¶é©±åŠ¨çš„ JavaScript è¿è¡Œæ—¶ã€‚</h3>
<blockquote>
<ul>
<li>JRE æ˜¯ java è¿è¡Œæ—¶ç¯å¢ƒ</li>
<li>C Runtime</li>
<li>.NET Common Language Runtime</li>
</ul>
<p>è¿è¡Œæ—¶ runtime å°±æ˜¯ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œ</p>
<p>æŒ‡çš„æ˜¯æŒ‡ä»¤åŠ è½½åˆ°å†…å­˜å¹¶ç”± CPU æ‰§è¡Œçš„æ—¶å€™ã€‚</p>
<p>è¿è¡Œæ—¶åº“å°±æ˜¯ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­æ‰€éœ€è¦ä¾èµ–çš„åº“ã€‚</p>
<p>C ä»£ç ç¼–è¯‘æˆå¯æ‰§è¡Œæ–‡ä»¶çš„æ—¶å€™ï¼ŒæŒ‡ä»¤æ²¡æœ‰è¢« CPU æ‰§è¡Œï¼Œè¿™ä¸ªæ—¶å€™ç®—æ˜¯<strong>ç¼–è¯‘æ—¶</strong>ã€‚</p>
</blockquote>
<h3 id="nodejs-ç‰¹æ€§å…¶å®å°±æ˜¯-js-ç‰¹æ€§">node.js ç‰¹æ€§å…¶å®å°±æ˜¯ JS ç‰¹æ€§ï¼š</h3>
<ul>
<li>éé˜»å¡ I/O</li>
<li>äº‹ä»¶é©±åŠ¨</li>
</ul>
<h3 id="node-å†å²-ä¸ºæ€§èƒ½è€Œç”Ÿ">node å†å² â€” ä¸ºæ€§èƒ½è€Œç”Ÿ</h3>
<blockquote>
<p>Ryan Dahl(Google Brain)ï¼Œä»–çš„å·¥ä½œæ˜¯ç”¨ C/C++ å†™é«˜æ€§èƒ½ Web æœåŠ¡ã€‚å¯¹äºé«˜æ€§èƒ½ï¼Œå¼‚æ­¥ IOã€äº‹ä»¶é©±åŠ¨æ˜¯åŸºæœ¬åŸåˆ™ï¼Œä½†æ˜¯ç”¨ C/C++ æ¥å†™å°±å¤ªç—›è‹¦äº†ã€‚äºæ˜¯ä»–å¼€å§‹è®¾æƒ³ç”¨é«˜çº§è¯­è¨€å¼€å‘ Web æœåŠ¡ã€‚ä»–è¯„ä¼°äº†å¾ˆå¤šç§é«˜çº§åŸå› ï¼Œè¿˜æƒ³å¾ˆå¤šè¯­è¨€è™½ç„¶åŒæ—¶æä¾›äº†åŒæ­¥ IO å’Œå¼‚æ­¥ IOï¼Œä½†æ˜¯å¼€å‘äººå‘˜ä¸€æ—¦ç”¨äº†åŒæ­¥ IOï¼Œä»–ä»¬å°±å†ä¹Ÿæ‡’å¾—å†™å¼‚æ­¥ IOï¼Œæ‰€ä»¥æœ€ç»ˆ Ryan ç„å‘äº† JavaScriptã€‚</p>
<p>å› ä¸º JavaScript æ˜¯å•çº¿ç¨‹æ‰§è¡Œï¼Œæ ¹æœ¬ä¸èƒ½è¿›è¡ŒåŒæ­¥ IO æ“ä½œï¼Œæ‰€ä»¥ JavaScript çš„è¿™ä¸€&quot;ç¼ºé™·&quot;å¯¼è‡´äº†å®ƒåªèƒ½ä½¿ç”¨å¼‚æ­¥IOã€‚</p>
<p>é€‰å®šäº†å¼€å‘è¯­è¨€ï¼Œè¿˜è¦æœ‰è¿è¡Œæ—¶ç¯å¢ƒï¼ŒV8 å°±æ˜¯å¼€æºçš„ JavaScript å¼•æ“ã€‚äºæ˜¯åœ¨2009ï¼ŒRyan æ­£å¼æ¨å‡ºäº†åŸºäº JavaScript è¯­è¨€å’Œ V8 å¼•æ“çš„å¼€æº Web æœåŠ¡å™¨é¡¹ç›®ï¼Œå‘½åä¸º Node.jsã€‚Node ç¬¬ä¸€æ¬¡æŠŠ JavaScript å¸¦å…¥åˆ°åç«¯æœåŠ¡å™¨å¼€å‘ã€‚</p>
</blockquote>
<h3 id="å¹¶å‘å¤„ç†çš„æ›´æ›¿">å¹¶å‘å¤„ç†çš„æ›´æ›¿</h3>
<ul>
<li>
<p>å¤šè¿›ç¨‹ - Linux C / Apache</p>
<blockquote>
<p>è¿›ç¨‹çš„ç¼ºé™·ï¼š</p>
<ul>
<li>åˆ›å»ºå’Œåˆ‡æ¢çš„æ—¶é—´å’Œç©ºé—´å¼€é”€è¾ƒå¤§ï¼Œä¸”éšç€å¹¶å‘è¿›ç¨‹æ•°é‡çš„æå‡ï¼Œæ—¶é—´å’Œç©ºé—´çš„å¼€é”€ä¼šé€æ¸å¢å¤§ï¼Œä»è€Œé™åˆ¶äº†ç³»ç»Ÿçš„å¹¶å‘èƒ½åŠ›ã€‚</li>
<li>è¿›ç¨‹é—´çš„èµ„æºå…±äº«ä¸æ–¹ä¾¿</li>
</ul>
</blockquote>
</li>
<li>
<p>å¤šçº¿ç¨‹ - Java</p>
</li>
<li>
<p>å¼‚æ­¥ I/O - JavaScript</p>
</li>
<li>
<p>åç¨‹ - Lua / OpenResty / Go / deno (go + TS)</p>
</li>
</ul>
<blockquote>
<p>deno</p>
<p><a href="https://studygolang.com/articles/13101"> https://studygolang.com/articles/13101 </a></p>
</blockquote>
<h3 id="ä¸å‰ç«¯ä¸­-js-å¼‚åŒ">ä¸å‰ç«¯ä¸­ JS å¼‚åŒ</h3>
<ul>
<li>æ ¸å¿ƒè¯­æ³•ä¸å˜</li>
<li>å‰ç«¯ï¼šBOM / DOM</li>
<li>åç«¯ï¼šfs / http / buffer / event / os</li>
</ul>
<h2 id="ä½¿ç”¨">ä½¿ç”¨</h2>
<h3 id="è¿è¡Œ">è¿è¡Œ</h3>
<p>æ¯æ¬¡ä¿®æ”¹ js æ–‡ä»¶éœ€é‡æ–°æ‰§ï¨ˆæ‰èƒ½ç”Ÿæ•ˆï¼Œå®‰è£… nodemon å¯ä»¥ç›‘è§†æ–‡ä»¶æ”¹åŠ¨ï¼Œè‡ªåŠ¨é‡å¯ï¼š</p>
<pre><code>npm i -g nodemon
</code></pre>
<h3 id="è°ƒè¯•">è°ƒè¯•</h3>
<p>Debug - Start Debugging</p>
<blockquote>
<p>https://nodejs.org/en/</p>
</blockquote>
<h3 id="ä½¿ç”¨æ¨¡å—">ä½¿ç”¨æ¨¡å—</h3>
<ul>
<li>
<p>node å†…å»ºæ¨¡å—</p>
<pre><code class="language-js">// å†…å»ºæ¨¡å—ç›´æ¥å¼•ç”¨
const os = require('os')
const mem = os.freemem() / os.totalmem() * 100
console.log(`å†…å­˜å ç”¨ç‡${mem.toFixed(2)}%`)
</code></pre>
</li>
<li>
<p>ç¬¬ä¸‰æ–¹æ¨¡å—</p>
<blockquote>
<p><a href="https://www.npmjs.com/">https://www.npmjs.com/</a></p>
</blockquote>
<pre><code class="language-js">// åŒçº§ CPU å ç”¨ç‡ï¼Œå…ˆå®‰è£…
npm i download-git-repo -S
</code></pre>
<pre><code class="language-js">// å¯¼å…¥å¹¶ä½¿ç”¨
const download = require('download-git-repo')
const ora = require('ora')

const process = ora('ä¸‹è½½ä¸­...')
process.start()

download('github:yuuFen/vue-template-for-cli-demo', '../test', (err) =&gt; {
  // console.log(err ? 'Error' : 'Success')
  if (err) {
    process.fail()
  } else {
    process.succeed()
  }
})
</code></pre>
</li>
<li>
<p>promisefy</p>
<blockquote>
<p>è®©å¼‚æ­¥ä»»åŠ¡ä¸²è¡ŒåŒ–ï¼ˆè¦ç¬¦åˆè§„èŒƒï¼‰</p>
</blockquote>
<pre><code class="language-js">const repo = 'github:yuuFen/vue-template-for-cli-demo'
const desc = '../test'
clone(repo, desc)

async function clone(repo, desc) {
  const { pormisify } = require('util')
  const download = promisify(require('download-git-repo'))
  const ora = require('ora')
  const process = ora('ä¸‹è½½ä¸­...')
  process.start()
  try {
    await download(repo, desc)
  } catch (err) {
    process.fail()
  }
  process.succeed()
}
</code></pre>
</li>
<li>
<p>è‡ªå®šä¹‰æ¨¡å—</p>
<pre><code class="language-js">// download.js
// å¯ä»¥ä½œä¸ºå¯¼å‡ºå¯¹è±¡çš„å±æ€§å¯¼å‡º
module.exports.clone = async function clone(repo, desc) {
  const { pormisify } = require('util')
  const download = promisify(require('download-git-repo'))
  const ora = require('ora')
  const process = ora('ä¸‹è½½ä¸­...')
  process.start()
  try {
    await download(repo, desc)
  } catch (err) {
    process.fail()
  }
  process.succeed()
}

// run
const { clone } = require('./download')
const repo = 'github:yuuFen/vue-template-for-cli-demo'
const desc = '../test'

clone(repo, desc)
</code></pre>
</li>
</ul>
<h2 id="api">API</h2>
<h3 id="fs">fs</h3>
<pre><code class="language-js">const fs = require('fs')

// åŒæ­¥è°ƒç”¨
const data = fs.readFileSync('./download.js')
// data ç±»å‹ä¸º Buffer
console.log(data.toString())

// å¼‚æ­¥
fs.readFile('./download.js', (err, data) =&gt; {
    if (err) throw err
    console.log(data.toString())
})

// fs å¸¸æ­é… path api ä½¿ç”¨
const path = require('path')
fs.readFile(path.resolve(path.resolve(__dirname, './download.js')), (err, data) =&gt; {
    if (err) throw err
    console.log(data.toString())
})

// prromisify
const { promisify } = require('util')
const readFile = promisify(fs.readFile)
readFile('./download.js').then(data =&gt; console.log(data))

// fs Promises API node v10
const fsp = require('fs').promises
fsp
    .readFile('./download.js')
    .then(data =&gt; console.log(data))
	.catch(err =&gt; console.log(err))
</code></pre>
<h3 id="buffer">Buffer</h3>
<blockquote>
<p>ç”¨äºåœ¨ TCP æµã€æ–‡ä»¶ç³»ç»Ÿæ“ä½œã€ä»¥åŠå…¶ä»–ä¸Šä¸‹æ–‡ä¸­ä¸å…«ä½å­—èŠ‚æµè¿›ï¨ˆäº¤äº’ã€‚ å…«ä½å­—èŠ‚ç»„æˆçš„æ•°ç»„ï¼Œå¯ä»¥æœ‰æ•ˆçš„åœ¨ JS ä¸­å­˜å‚¨äºŒè¿›åˆ¶æ•°æ®ã€‚</p>
</blockquote>
<pre><code class="language-js">// åˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º 10 å­—èŠ‚ä»¥ 0 å¡«å……çš„Buffer
const buf1 = Buffer.alloc(10)
console.log(buf1)

// åˆ›å»ºä¸€ä¸ª Buffer åŒ…å« ascii
const buf2 = Buffer.from('a')
console.log(buf2, buf2.toString())

// åˆ›å»º Buffer åŒ…å« UTF-8 å­—èŠ‚
// UFT-8ï¼šä¸€ç§å˜é•¿çš„ç¼–ç æ–¹æ¡ˆï¼Œä½¿ç”¨ 1 ~ 6 ä¸ªå­—èŠ‚æ¥å­˜å‚¨
// UFT-32ï¼šä¸€ç§å›ºå®šé•¿åº¦çš„ç¼–ç æ–¹æ¡ˆï¼Œï¥§ç®¡å­—ç¬¦ç¼–å·å¤§å°ï¼Œå§‹ç»ˆä½¿ç”¨ 4 ä¸ªå­—èŠ‚æ¥å­˜å‚¨
// UTF-16ï¼šä»‹äº UTF-8 å’Œ UTF-32 ä¹‹é—´ï¼Œä½¿ç”¨ 2 ä¸ªæˆ–è€… 4 ä¸ªå­—èŠ‚æ¥å­˜å‚¨ï¼Œé•¿åº¦æ—¢å›ºå®šåˆå¯å˜
const buf3 = Buffer.from('Buffer åˆ›å»ºæ–¹æ³•')
console.log(buf3)

// å†™å…¥Bufferæ•°æ®
buf1.write('hello')
console.log(buf1)

// è¯»å–Bufferæ•°æ®  
console.log(buf3.toString())  

// åˆå¹¶Buffer  
const buf4 = Buffer.concat([buf1, buf3])
console.log(buf4.toString());
</code></pre>
<h3 id="http">http</h3>
<blockquote>
<p>ç”¨äºåˆ›å»º web æœåŠ¡çš„æ¨¡å—</p>
</blockquote>
<ul>
<li>åˆ›å»ºä¸€ä¸ªhttpæœåŠ¡å™¨</li>
</ul>
<pre><code class="language-js">const http = require('http')
const server = http.createServer((request, response) =&gt; {
    // æ‰“å°ä¸€ä¸‹ response çš„åŸå‹é“¾
    console.log(getPrototypeChain(response))
    // response æ˜¯ä¸€ä¸ª Steam
    response.end('a response from server')
})

server.listen(3000)


function getPrototypeChain(obj) {
    let prototypeChain = []
    while (obj = Object.getPrototypeOf(obj)) {
        prototypeChain.push(obj)
    }
    prototypeChain.push(null)
    return prototypeChain
}
</code></pre>
<p>æ˜¾ç¤ºé¦–é¡µ / å®ç°æ¥å£</p>
<pre><code class="language-js">const http = require('http')
const fs = require('fs')

const server = http.createServer((request, response) =&gt; {
  const { url, method } = request

  if (url === '/' &amp;&amp; method === 'GET') {
    fs.readFile('./index.html', (err, data) =&gt; {
      if (err) {
        response.writeHead(500, { 'Content-Type': 'text/plain;charset=utf-8' })
        response.end('500 æœåŠ¡ç«¯é”™è¯¯')
      }
      response.statusCode = 200
      response.setHeader('Content-Type', 'text/html')
      response.end(data)
    })
  } else if (url === '/users' &amp;&amp; method === 'GET') {
    response.setHeader('Content-Type', 'application/json')
    response.end(JSON.stringify({ name: 'name' }))
  } else {
    response.statusCode = 404
    response.setHeader('Content-Type', 'text/plain;charset=utf-8')
    response.end('404 é¡µé¢ä¸å­˜åœ¨')
  }
})

server.listen(3000)
</code></pre>
<h3 id="stream">stream</h3>
<blockquote>
<p>ç”¨äºä¸ node ä¸­æµæ•°æ®äº¤äº’çš„æ¥å£</p>
</blockquote>
<pre><code class="language-js">const fs = require('fs')

const rs = fs.createReadStream('./img1.png')
const ws = fs.createWriteStream('./img2.png')
// åœ¨å†…å­˜ä¸­ä»¥å­—èŠ‚æµåŠ¨ï¼Œé˜²æ­¢ä¼ è¾“å¤§æ–‡ä»¶æ—¶å†…å­˜å ç”¨è¿‡é«˜
rs.pipe(ws)
</code></pre>
<figure data-type="image" tabindex="1"><img src="https://yuufen.com/blog/post-images/1587322423228.png" alt="" loading="lazy"></figure>
<p>å“åº”å›¾ç‰‡è¯·æ±‚</p>
<pre><code class="language-js">const http = require('http')
const fs = require('fs')

const server = http.createServer((request, response) =&gt; {
  const { url, method, headers } = request

  if (url === '/' &amp;&amp; method === 'GET') {
    fs.readFile('./index.html', (err, data) =&gt; {
      if (err) {
        response.writeHead(500, { 'Content-Type': 'text/plain;charset=utf-8' })
        response.end('500 æœåŠ¡ç«¯é”™è¯¯')
      }
      response.statusCode = 200
      response.setHeader('Content-Type', 'text/html')
      response.end(data)
    })
  } else if (method === 'GET' &amp;&amp; headers.accept.indexOf('image/*') !== -1) {
    console.log(url) // '/img.png'
	// response æ˜¯ Stream
    fs.createReadStream('.' + url).pipe(response)
  }
})

server.listen(3000)
</code></pre>
<h2 id="åˆ©ç”¨æ–‡ä»¶ç³»ç»Ÿå®ç°æ•°æ®æŒä¹…åŒ–">åˆ©ç”¨æ–‡ä»¶ç³»ç»Ÿå®ç°æ•°æ®æŒä¹…åŒ–</h2>
<pre><code class="language-js">const fs = require('fs')

function get(key) {
  fs.readFile('./db.json', (err, data) =&gt; {
    const json = JSON.parse(data)
    console.log(json[key])
  })
}

function set(key, value) {
  fs.readFile('./db.json', (err, data) =&gt; {
    // å¯èƒ½æ˜¯ç©ºæ–‡ä»¶
    const json = data ? JSON.parse(data) : {}
    json[key] = value
    fs.writeFile('./db.json', JSON.stringify(json), (err) =&gt; {
      if (err) {
        console.log(err)
      } else {
        console.log('å†™å…¥æˆåŠŸ')
      }
    })
  })
}

/**
 * å‘½ä»¤è¡Œæ¥å£
 * set foo doo
 * get foo
 * quit
 */
const readline = require('readline')
const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout,
})

rl.on('line', function (input) {
  const [op, key, value] = input.split(' ')
  if (op === 'get') {
    get(key)
  } else if (op === 'set') {
    set(key, value)
  } else if (op === 'quit') {
    rl.close()
  } else {
    console.log('æ— æ•ˆæŒ‡ä»¤')
  }
})

rl.on('close', function () {
  console.log('ç¨‹åºç»“æŸ')
  process.exit(0)
})
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[è™šæ‹Ÿ DOM ç®€å•å®ç°]]></title>
        <id>https://yuufen.com/blog/post/M0Xa7RsWm/</id>
        <link href="https://yuufen.com/blog/post/M0Xa7RsWm/">
        </link>
        <updated>2020-04-01T03:24:31.000Z</updated>
        <content type="html"><![CDATA[<h2 id="é¡¹ç›®åœ°å€">é¡¹ç›®åœ°å€</h2>
<p>https://github.com/yuuFen/Virtual-DOM</p>
<h2 id="ä¸ºä»€ä¹ˆéœ€è¦è™šæ‹Ÿ-dom">ä¸ºä»€ä¹ˆéœ€è¦è™šæ‹Ÿ DOM</h2>
<figure data-type="image" tabindex="1"><img src="https://yuufen.com/blog/post-images/1586510765752.png" alt="" loading="lazy"></figure>
<p>çœŸå® DOM éå¸¸å¤æ‚ï¼Œæ‹¥æœ‰è®¸å¤šå±æ€§ï¼Œæ‰€ä»¥ DOM çš„æ“ä½œå¼€é”€å·¨å¤§ï¼Œéœ€è¦å°½å¯èƒ½çš„å°‘æ“ä½œ DOMã€‚</p>
<figure data-type="image" tabindex="2"><img src="https://yuufen.com/blog/post-images/1586523343141.png" alt="" loading="lazy"></figure>
<p>ä½¿ç”¨è‡ªå®šä¹‰çš„ä¸€ä¸ªå¯¹è±¡æ¥æè¿° DOMï¼Œå¯ä»¥æœ‰æ•ˆå‡å°‘å¤æ‚åº¦ã€‚</p>
<h2 id="åˆ›å»ºè™šæ‹Ÿ-dom">åˆ›å»ºè™šæ‹Ÿ DOM</h2>
<pre><code class="language-js">let vnode = createElement('div', { id: 'test' }, [
    createElement('p', {}, ['èŠ‚ç‚¹1'])
])
console.log(JSON.stringify(vnode, null, 2))
</code></pre>
<pre><code class="language-js">function createElement(tag, data, children) {
  let flag
  if (typeof tag == 'string') {
    // æ™®é€šçš„ html æ ‡ç­¾
    flag = vnodeType.HTML
  } else if (typeof tag == 'function') {
    flag = vnodeType.COMPONENT
  } else {
    flag = vnodeType.TEXT
  }

  let childrenFlag
  if (children == null) {
    childrenFlag = childrenType.EMPTY
  } else if (Array.isArray(children)) {
    let length = children.length
    if (length === 0) {
      childrenFlag = childrenType.SINGLE
    } else {
      childrenFlag = childrenType.MULTIPLE
    }
  } else {
    // å…¶ä»–æƒ…å†µè®¤ä¸ºæ˜¯æ–‡æœ¬
    childrenFlag = childrenType.SINGLE
    children = createTextVNode(children + '')
  }

  // è¿”å› vnode
  return {
    flag, // vnode ç±»å‹
    tag, // æ ‡ç­¾ç±»å‹ / æ–‡æœ¬æ²¡æœ‰ tag / ç»„ä»¶çš„ tag æ˜¯å‡½æ•°
    data,
    children,
    childrenFlag,
  }
}

function createTextVNode(text) {
  return {
    flag: vnodeType.TEXT,
    tag: null,
    data: null,
    children: text,
    childrenFlag: childrenType.EMPTY,
  }
}
</code></pre>
<h2 id="æ¸²æŸ“">æ¸²æŸ“</h2>
<pre><code class="language-js">      let vnode = createElement('div', { id: 'test' }, [
        createElement('p', { key: 'a',style: { color: 'blue' } }, ['èŠ‚ç‚¹1']),
        createElement('p', { key: 'b', '@click': () =&gt; { alert('xx') } }, ['èŠ‚ç‚¹2']),
        createElement('p', { key: 'c', 'class': 'item-header' }, ['èŠ‚ç‚¹3']),
        createElement('p', { key: 'd' }, ['èŠ‚ç‚¹4']),
      ])

      render(vnode, document.getElementById('app'))
</code></pre>
<pre><code class="language-js">// è¦æ¸²æŸ“çš„ vnodeã€å®¹å™¨ï¼ˆçˆ¶å…ƒç´ ï¼‰
function render(vnode, container) {
  // é¦–æ¬¡æ¸²æŸ“
  mount(vnode, container)
}

// é¦–æ¬¡æŒ‚è½½å…ƒç´ 
function mount(vnode, container) {
  let { flag } = vnode
  if (flag == vnodeType.HTML) {
    // (åº”è¯¥ä½¿ç”¨å¯¹è±¡å®ç°ï¼Œä¸ç„¶ä¾èµ–æœ‰ç‚¹ä¹±)
    mountElement(vnode, container)
  } else if (flag == vnodeType.TEXT) {
    mountText(vnode, container)
  }
}

function mountElement(vnode, container) {
  let dom = document.createElement(vnode.tag)
  vnode.el = dom
  let { data, children, childrenFlag } = vnode

  // æŒ‚è½½ key
  if (data) {
    for (let key in data) {
      patchData(dom, key, null, data[key])
    }
  }

  if (childrenFlag !== childrenType.EMPTY) {
    if (childrenFlag == childrenType.SINGLE) {
      mount(children, dom)
    } else if (childrenFlag == childrenType.MULTIPLE) {
      for (let i = 0; i &lt; children.length; i++) {
        mount(children[i], dom)
      }
    }
  }

  container.appendChild(dom)
}

function mountText(vnode, container) {
  let dom = document.createTextNode(vnode.children)
  vnode.el = dom
  container.appendChild(dom)
}

function patchData(el, key, prv, next) {
  switch (key) {
    case 'style':
      for (let key in next) {
        el.style[key] = next[key]
      }
      break
    case 'class':
      el.className = next
      break
    default:
      if (key[0] === '@') {
        if (next) {
          el.addEventListener(key.slice[1], next)
        }
      } else {
        el.setAttribute(key, next)
      }
      break
  }
}
</code></pre>
<h2 id="è¡¥ä¸">è¡¥ä¸</h2>
<pre><code class="language-js">function patch(prev, next, container) {
  const nextFlag = next.flag
  const prevFlag = prev.flag

  // å¦‚ element å˜ä¸º text, ç›´æ¥æ›¿æ¢, ä¸ç®¡ children
  if (nextFlag !== prevFlag) {
    replaceVNode(prev, next, container)
  } else if (nextFlag == vnodeType.HTML) {
    patchElement(prev, next, container)
  } else if (nextFlag == vnodeType.TEXT) {
    patchText(prev, next, container)
  }
}

function patchElement(prev, next, container) {
  if (prev.tag !== next.tag) {
    replaceVNode(prev, next, container)
    return
  }
  const el = (next.el = prev.el)

  // patch data
  const prevData = prev.data
  const nextData = next.data
  if (nextData) {
    for (const key in nextData) {
      const prevVal = prevData[key]
      const nextVal = nextData[key]
      patchData(el, key, prevVal, nextVal)
    }
  }
  if (prevData) {
    for (const key in prevData) {
      const prevVal = prevData[key]
      if (prevVal &amp;&amp; !nextData.hasOwnProperty(key)) {
        patchData(el, key, prevVal, null)
      }
    }
  }

  // patch children
  patchChildren(prev.childrenFlag, next.childrenFlag, prev.children, next.children, el)
}

function patchChildren(prevChildrenFlag, nextChildrenFlag, prevChildren, nextChildren, container) {
  // 1. è€çš„æ˜¯ å•ç‹¬çš„ / ç©ºçš„ / å¤šä¸ª
  // 2. æ–°çš„æ˜¯ å•ç‹¬çš„ / ç©ºçš„ / å¤šä¸ª
  switch (prevChildrenFlag) {
    case childrenType.SINGLE:
      switch (nextChildrenFlag) {
        case childrenType.SINGLE:
          patch(prevChildren, nextChildren, container)
          break
        case childrenType.EMPTY:
          container.removeChild(prevChildren.el)
          break
        case childrenType.MULTIPLE:
          container.removeChild(prevChildren.el)
          for (let i = 0; i &lt; nextChildren.length; i++) {
            mount(nextChildren[i], container)
          }
          break
      }
      break

    case childrenType.EMPTY:
      switch (nextChildrenFlag) {
        case childrenType.SINGLE:
          mount(nextChildren, container)
          break
        case childrenType.EMPTY:
          break
        case childrenType.MULTIPLE:
          for (let i = 0; i &lt; nextChildren.length; i++) {
            mount(nextChildren[i], container)
          }
          break
      }
      break

    case childrenType.MULTIPLE:
      switch (nextChildrenFlag) {
        case childrenType.SINGLE:
          for (let i = 0; i &lt; prevChildren.length; i++) {
            container.removeChild(prevChildren[i].el)
          }
          mount(nextChildren, container)
          break
        case childrenType.EMPTY:
          for (let i = 0; i &lt; prevChildren.length; i++) {
            container.removeChild(prevChildren[i].el)
          }
          break
        case childrenType.MULTIPLE:
          // ä¼—å¤šè™šæ‹Ÿ DOM å°±åœ¨è¿™é‡Œäº§ç”Ÿåˆ†æ­§ï¼Œæ¯å®¶çš„ä¼˜åŒ–ç­–ç•¥ä¸ä¸€æ ·
          // è€ï¼š[abc] æ–°ï¼š[c**a**b**]
          // ab ä¸éœ€è¦æ›´æ”¹ï¼Œåªéœ€è¦åœ¨ ab ä¹‹é—´æˆ–ä¹‹å‰æ’å…¥å…ƒç´ ï¼Œæˆ–åœ¨æœ€åæ–°å»ºå…ƒç´ 
          let lastIndex = 0
          for (let i = 0; i &lt; nextChildren.length; i++) {
            let find = false
            const nextVNode = nextChildren[i]
            for (let j = 0; j &lt; prevChildren.length; j++) {
              const prevVNode = prevChildren[j]
              if (prevVNode.key === nextVNode.key) {
                find = true
                // å¦‚æœ key ç›¸åŒï¼Œè®¤ä¸ºæ˜¯åŒä¸€ä¸ªå…ƒç´ ï¼Œè¡¥ä¸ä¸€ä¸‹ï¼Œä¸æ–°å»ºæˆ–é”€æ¯
                patch(prevVNode, nextVNode, container)
                if (j &lt; lastIndex) {
                  // éœ€è¦ç§»åŠ¨çš„æƒ…å†µ
                  // lastIndex æŒ‡çš„æ˜¯ä¸Šä¸€ä¸ªæ‰¾åˆ°çš„å…ƒç´ åœ¨ prevVNode ä¸­çš„ä½ç½®
                  // j å°±æ˜¯æœ€æ–°æ‰¾åˆ°çš„å…ƒç´ åœ¨ prevVNode ä¸­çš„ä½ç½®
                  // ä½¿ç”¨ insertBefore ç§»åŠ¨å…ƒç´ 
                  const flagNode = nextChildren[i - 1].el.nextSibling
                  container.insertBefore(prevVNode.el, flagNode)
                } else {
                  // å¦‚æœé¡ºåºæ­£ç¡®ï¼Œå°±æ›´æ–°æœ«å°¾ä½ç½®
                  lastIndex = j
                }
              }
            }
            if (!find) {
              // éœ€è¦æ–°å¢
              const flagNode = i == 0 ? prevChildren[0].el : nextChildren[i - 1].el.nextSibling
              mount(nextVNode, container, flagNode)
            }
          }

          // ç§»é™¤ä¸éœ€è¦çš„å…ƒç´ 
          for (let i = 0; i &lt; prevChildren.length; i++) {
            const prevVNode = prevChildren[i]
            const has = nextChildren.find((next) =&gt; next.key === prevVNode.key)
            if (!has) {
              container.removeChild(prevVNode.el)
            }
          }
          break
      }
      break
  }
}

function patchText(prev, next, container) {
  const el = (next.el = prev.el)
  if (next.children !== prev.children) {
    el.nodeValue = next.children
  }
}

function patchData(el, key, prev, next) {
  switch (key) {
    case 'style':
      for (let key in next) {
        el.style[key] = next[key]
      }
      for (let key in prev) {
        if (!next || !next.hasOwnProperty(key)) {
          el.style[key] = ''
        }
      }

      break
    case 'class':
      el.className = next
      break
    default:
      if (key[0] === '@') {
        if (prev) {
          el.removeEventListener(key.slice(1), prev)
        }
        if (next) {
          el.addEventListener(key.slice(1), next)
        }
      } else {
        el.setAttribute(key, next)
      }
      break
  }
}

function replaceVNode(prev, next, container) {
  container.removeChild(prev.el)
  mount(next, container)
}
</code></pre>
<h2 id="vue-ä¸­çš„ä¼˜åŒ–">Vue ä¸­çš„ä¼˜åŒ–</h2>
<p>å¯¹å¸¸è§çš„ä¿®æ”¹ï¼šæ–°å¢ã€åˆ é™¤ã€å€’åºæ’åˆ—åšäº†ç‰¹å®šä¼˜åŒ–ï¼Œè¯¦ç»†è§ä¹‹å‰æ–‡ç« ã€‚</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[å®ç°ç®€å•çš„ SSR]]></title>
        <id>https://yuufen.com/blog/post/s-05vytU3/</id>
        <link href="https://yuufen.com/blog/post/s-05vytU3/">
        </link>
        <updated>2020-03-25T02:49:07.000Z</updated>
        <content type="html"><![CDATA[<h2 id="æ¸²æŸ“æœåŠ¡å™¨">æ¸²æŸ“æœåŠ¡å™¨</h2>
<p>server/index.js</p>
<pre><code class="language-js">const express = require('express')
const Vue = require('vue')
const fs = require('fs')

// åˆ›å»º express å®ä¾‹
const app = express()

const { createBundleRenderer } = require('vue-server-renderer')

const bundle = require('../dist/server/vue-ssr-server-bundle.json')
const clientManifest = require('../dist/server/vue-ssr-client-bundle.json')
const renderer = createBundleRenderer(bundle, {
  runInNewContext: false,
  template: fs.readFileSync('./src/index.temp.html'),
  clientManifest: clientManifest,
})

function renderToString(context) {
  return new Promise((resolve, reject) =&gt; {
    renderer.renderToString(context, (err, html) =&gt; {
      if (err) {
        reject(err)
        return
      }
      resolve(html)
    })
  })
}

// // åˆ›å»º vue å®ä¾‹
// const vm = new Vue({
//   data: { cnt: 1 },
//   template: `
//     &lt;div&gt;{{cnt}}&lt;/div&gt;
//   `,
// })

// å®¢æˆ·ç«¯éƒ¨ç½²é™æ€æ–‡ä»¶
app.use(express.static('../dist/client'))
// å£°æ˜æœåŠ¡ç«¯è·¯ç”±
app.get('*', async function (req, res) {
  try {
    const context = {
      title: 'ssr test',
      url: req.url,
    }
    const html = await renderToString(context)
    res.send(html)
  } catch (err) {
    res.status(500).send('Internal Server Error')
  }
})

app.listen(3000, () =&gt; {
  console.log('æ¸²æŸ“æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ')
})
</code></pre>
<h2 id="æ‰“åŒ…å…¥å£æ–‡ä»¶">æ‰“åŒ…å…¥å£æ–‡ä»¶</h2>
<h3 id="appjs">app.js</h3>
<pre><code class="language-js">// é€šç”¨ï¼šåˆ›å»º Vue å®ä¾‹

import Vue from 'vue'
import App from './App.vue'
import { createRouter } from './router'
import { createStore } from './store'

export function createApp(context) {
  const router = createRouter()
  const store = createStore()
  const app = new Vue({
    router,
    store,
    render: (h) =&gt; h(App),
  })
  return { app, router }
}
</code></pre>
<h3 id="entry-clientjs">entry-client.js</h3>
<pre><code class="language-js">import { createApp } from './app'

const { app, router } = createApp()

router.onReady(() =&gt; {
  // æŒ‚è½½
  app.$mount('#app')
})
</code></pre>
<h3 id="entry-serverjs">entry-server.js</h3>
<pre><code class="language-js">import { createApp } from './app'

export default (context) =&gt; {
  // è¿”å› Promiseï¼Œç¡®ä¿è·¯ç”±æˆ–ç»„ä»¶å‡†å¤‡å°±ç»ª
  return new Promise((resolve, reject) =&gt; {
    // åˆ›å»º vue å®ä¾‹
    const { app, router } = createApp(context)
    // è·³è½¬é¦–å±åœ°å€
    router.push(context.url)
    // å®Œæˆ promise
    router.onReady(() =&gt; {
      resolve(app)
    }, reject)
  })
}
</code></pre>
]]></content>
    </entry>
</feed>